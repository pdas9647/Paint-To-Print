!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Jd,Xd){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Jd);function n(t){const n=[];let r=0;for(let s=0;s<t.length;s++){let e=t.charCodeAt(s);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++s)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let c=0;c<n.length;c+=3){var i=n[c],a=c+1<n.length,o=a?n[c+1]:0,h=c+2<n.length,u=h?n[c+2]:0;let e=(15&o)<<2|u>>6,t=63&u;h||(t=64,a||(e=64)),s.push(r[i>>2],r[(3&i)<<4|o>>4],r[e],r[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var s,i,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(s=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&s)):239<a&&a<365?(i=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(s=e[n++],i=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&s)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let h=0;h<e.length;){var s=n[e.charAt(h++)],i=h<e.length?n[e.charAt(h)]:0;++h;var a=h<e.length?n[e.charAt(h)]:64;++h;var o=h<e.length?n[e.charAt(h)]:64;if(++h,null==s||null==i||null==a||null==o)throw Error();r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},a=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};function f(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function m(e){return e&&e._delegate?e._delegate:e}class i{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(nl=l=l||{})[nl.DEBUG=0]="DEBUG",nl[nl.VERBOSE=1]="VERBOSE",nl[nl.INFO=2]="INFO",nl[nl.WARN=3]="WARN",nl[nl.ERROR=4]="ERROR",nl[nl.SILENT=5]="SILENT";const o={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},h=l.INFO,u={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},c=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=u[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var d,g="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},p={},v=g||self;function y(){}function w(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function b(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var T="closure_uid_"+(1e9*Math.random()>>>0),E=0;function I(e,t,n){return e.call.apply(e.bind,arguments)}function _(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function S(e,t,n){return(S=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?I:_).apply(null,arguments)}function A(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function D(e,i){function t(){}t.prototype=i.prototype,e.Z=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Vb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function C(){this.s=this.s,this.o=this.o}var k={};C.prototype.s=!1,C.prototype.na=function(){var e,t;!this.s&&(this.s=!0,this.M(),0)&&(t=this,e=Object.prototype.hasOwnProperty.call(t,T)&&t[T]||(t[T]=++E),delete k[e])},C.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const N=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},x=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){var r=e.length,s="string"==typeof e?e.split(""):e;for(let i=0;i<r;i++)i in s&&t.call(n,s[i],i,e)};function R(){return Array.prototype.concat.apply([],arguments)}function L(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function O(e){return/^[\s\xa0]*$/.test(e)}var M,P=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function F(e,t){return-1!=e.indexOf(t)}function V(e,t){return e<t?-1:t<e?1:0}e:{var U=v.navigator;if(U){U=U.userAgent;if(U){M=U;break e}}M=""}function q(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function B(e){const t={};for(const n in e)t[n]=e[n];return t}var j="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function K(t){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(let e=0;e<j.length;e++)n=j[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function $(e){return $[" "](e),e}$[" "]=y;var G,H=F(M,"Opera"),W=F(M,"Trident")||F(M,"MSIE"),z=F(M,"Edge"),Q=z||W,Y=F(M,"Gecko")&&!(F(M.toLowerCase(),"webkit")&&!F(M,"Edge"))&&!(F(M,"Trident")||F(M,"MSIE"))&&!F(M,"Edge"),J=F(M.toLowerCase(),"webkit")&&!F(M,"Edge");function X(){var e=v.document;return e?e.documentMode:void 0}e:{var Z="",ee=(ee=M,Y?/rv:([^\);]+)(\)|;)/.exec(ee):z?/Edge\/([\d\.]+)/.exec(ee):W?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ee):J?/WebKit\/(\S+)/.exec(ee):H?/(?:Version)[ \/]?(\S+)/.exec(ee):void 0);if(ee&&(Z=ee?ee[1]:""),W){ee=X();if(null!=ee&&ee>parseFloat(Z)){G=String(ee);break e}}G=Z}var te={};function ne(){return e=function(){let e=0;var t=P(String(G)).split("."),n=P("9").split("."),r=Math.max(t.length,n.length);for(let a=0;0==e&&a<r;a++)for(var s=t[a]||"",i=n[a]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(e=V(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||V(0==s[2].length,0==i[2].length)||V(s[2],i[2]),s=s[3],i=i[3],0==e););return 0<=e},t=te,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=e(9);var e,t}var re=v.document&&W&&(X()||parseInt(G,10))||void 0,se=function(){if(!v.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{v.addEventListener("test",y,t),v.removeEventListener("test",y,t)}catch(e){}return e}();function ie(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}function ae(e,t){if(ie.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Y){e:{try{$(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:oe[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&ae.Z.h.call(this)}}ie.prototype.h=function(){this.defaultPrevented=!0},D(ae,ie);var oe={2:"touch",3:"pen",4:"mouse"};ae.prototype.h=function(){ae.Z.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var he="closure_listenable_"+(1e6*Math.random()|0),ue=0;function ce(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ia=s,this.key=++ue,this.ca=this.fa=!1}function le(e){e.ca=!0,e.listener=null,e.proxy=null,e.src=null,e.ia=null}function de(e){this.src=e,this.g={},this.h=0}function fe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=N(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(le(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function ge(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ca&&i.listener==t&&i.capture==!!n&&i.ia==r)return s}return-1}de.prototype.add=function(e,t,n,r,s){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var a=ge(e,t,r,s);return-1<a?(t=e[a],n||(t.fa=!1)):((t=new ce(t,this.src,i,!!r,s)).fa=n,e.push(t)),t};var me="closure_lm_"+(1e6*Math.random()|0),pe={};function ye(e,t,n,r,s){if(r&&r.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}r=_e(r);return t&&t[he]?t.O(n,r,b(s)?!!s.capture:!!s,i):ve(t,n,r,!0,s,i)}(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)ye(e,t[i],n,r,s);return null}return n=_e(n),e&&e[he]?e.N(t,n,b(r)?!!r.capture:!!r,s):ve(e,t,n,!1,r,s)}function ve(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a,o=b(s)?!!s.capture:!!s,h=Ee(e);if(h||(e[me]=h=new de(e)),(n=h.add(t,n,r,o,i)).proxy)return n;if(a=Te,r=function e(t){return a.call(e.src,e.listener,t)},(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=!se?o:s)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(be(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function we(e){var t,n,r;"number"!=typeof e&&e&&!e.ca&&((t=e.src)&&t[he]?fe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(be(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Ee(t))?(fe(n,e),0==n.h&&(n.src=null,t[me]=null)):le(e)))}function be(e){return e in pe?pe[e]:pe[e]="on"+e}function Te(e,t){var n,r;return e=!!e.ca||(t=new ae(t,this),n=e.listener,r=e.ia||e.src,e.fa&&we(e),n.call(r,t))}function Ee(e){return(e=e[me])instanceof de?e:null}var Ie="__closure_events_fn_"+(1e9*Math.random()>>>0);function _e(t){return"function"==typeof t?t:(t[Ie]||(t[Ie]=function(e){return t.handleEvent(e)}),t[Ie])}function Se(){C.call(this),this.i=new de(this),(this.P=this).I=null}function Ae(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new ie(t,e):t instanceof ie?t.target=t.target||e:(a=t,K(t=new ie(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=De(i,r,!0,t)&&a;if(a=De(i=t.g=e,r,!0,t)&&a,a=De(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=De(i=t.g=n[s],r,!1,t)&&a}function De(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,h=t[i];h&&!h.ca&&h.capture==n&&(a=h.listener,o=h.ia||h.src,h.fa&&fe(e.i,h),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}D(Se,C),Se.prototype[he]=!0,Se.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=b(s)?!!s.capture:!!s,r=_e(r),t&&t[he]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=ge(a=t.g[n],r,s,i))&&(le(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&Ee(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?ge(n,r,s,i):t)?n[t]:null)&&we(r))}(this,e,t,n,r)},Se.prototype.M=function(){if(Se.Z.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)le(n[r]);delete t.g[e],t.h--}}this.I=null},Se.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Se.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Ce=v.JSON.stringify;var ke,Ne=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new xe,e=>e.reset());class xe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Re(e,t){var n;ke||(n=v.Promise.resolve(void 0),ke=function(){n.then(Me)}),Le||(ke(),Le=!0),Oe.add(e,t)}var Le=!1,Oe=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ne.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Me(){for(var e;e=function(){var e=Oe;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){v.setTimeout(()=>{throw e},0)}(e)}var t=Ne;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Le=!1}function Pe(e,t){Se.call(this),this.h=e||1,this.g=t||v,this.j=S(this.kb,this),this.l=Date.now()}function Fe(e){e.da=!1,e.S&&(e.g.clearTimeout(e.S),e.S=null)}function Ve(e,t,n){if("function"==typeof e)n&&(e=S(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=S(e.handleEvent,e)}return 2147483647<Number(t)?-1:v.setTimeout(e,t||0)}D(Pe,Se),(d=Pe.prototype).da=!1,d.S=null,d.kb=function(){var e;this.da&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-e):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Ae(this,"tick"),this.da&&(Fe(this),this.start())))},d.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},d.M=function(){Pe.Z.M.call(this),Fe(this),delete this.g};class Ue extends C{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Ve(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(v.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function qe(e){C.call(this),this.h=e,this.g={}}D(qe,C);var Be=[];function je(e,t,n,r){Array.isArray(n)||(n&&(Be[0]=n.toString()),n=Be);for(var s=0;s<n.length;s++){var i=ye(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function Ke(e){q(e.g,function(e,t){this.g.hasOwnProperty(t)&&we(e)},e),e.g={}}function $e(){this.g=!0}function Ge(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return Ce(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}qe.prototype.M=function(){qe.Z.M.call(this),Ke(this)},qe.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},$e.prototype.Aa=function(){this.g=!1},$e.prototype.info=function(){};var He={},We=null;function ze(){return We=We||new Se}function Qe(e){ie.call(this,He.Ma,e)}function Ye(){var e=ze();Ae(e,new Qe(e))}function Je(e,t){ie.call(this,He.STAT_EVENT,e),this.stat=t}function Xe(e){var t=ze();Ae(t,new Je(t,e))}function Ze(e,t){ie.call(this,He.Na,e),this.size=t}function et(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return v.setTimeout(function(){e()},t)}He.Ma="serverreachability",D(Qe,ie),He.STAT_EVENT="statevent",D(Je,ie),He.Na="timingevent",D(Ze,ie);var tt={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},nt={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function rt(){}function st(e){return e.h||(e.h=e.i())}function it(){}rt.prototype.h=null;g={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function at(){ie.call(this,"d")}function ot(){ie.call(this,"c")}function ht(){}function ut(e,t,n,r){this.l=e,this.j=t,this.m=n,this.X=r||1,this.V=new qe(this),this.P=dt,this.W=new Pe(e=Q?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ct}function ct(){this.i=null,this.g="",this.h=!1}D(at,ie),D(ot,ie),D(ht,rt),ht.prototype.g=function(){return new XMLHttpRequest},ht.prototype.i=function(){return{}};var lt=new ht,dt=45e3,ft={},gt={};function mt(e,t,n){e.K=1,e.v=Ft(xt(t)),e.s=n,e.U=!0,pt(e,null)}function pt(e,t){e.F=Date.now(),wt(e),e.A=xt(e.v);var a,o,h,u,c,l,n=e.A,r=e.X;Array.isArray(r)||(r=[String(r)]),Yt(n.h,"t",r),e.C=0,n=e.l.H,e.h=new ct,e.g=Jn(e.l,n?t:null,!e.s),0<e.O&&(e.L=new Ue(S(e.Ia,e,e.g),e.O)),je(e.V,e.g,"readystatechange",e.gb),t=e.H?B(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.s,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Ye(),a=e.j,o=e.u,h=e.A,u=e.m,c=e.X,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+u+") [attempt "+c+"]: "+o+"\n"+h+"\n"+e})}function yt(e){return e.g&&("GET"==e.u&&2!=e.K&&e.l.Ba)}function vt(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if(s=(a=n,h=o=void 0,o=(i=e).C,-1==(h=a.indexOf("\n",o))?gt:(o=Number(a.substring(o,h)),isNaN(o)?ft:(h+=1)+o>a.length?gt:(a=a.substr(h,o),i.C=h+o,a))),s==gt){4==t&&(e.o=4,Xe(14),r=!1),Ge(e.j,e.m,null,"[Incomplete Response]");break}if(s==ft){e.o=4,Xe(15),Ge(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}Ge(e.j,e.m,s,null),_t(e,s)}var i,a,o,h;yt(e)&&s!=gt&&s!=ft&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,Xe(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.aa&&(e.aa=!0,(t=e.l).g==e&&t.$&&!t.L&&(t.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Kn(t),t.L=!0,Xe(11))):(Ge(e.j,e.m,n,"[Invalid Chunked Response]"),It(e),Et(e))}function wt(e){e.Y=Date.now()+e.P,bt(e,e.P)}function bt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=et(S(e.eb,e),t)}function Tt(e){e.B&&(v.clearTimeout(e.B),e.B=null)}function Et(e){0==e.l.G||e.I||Hn(e.l,e)}function It(e){Tt(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,Fe(e.W),Ke(e.V),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function _t(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||rn(n.i,e)))if(n.I=e.N,!e.J&&rn(n.i,e)&&3==n.G){try{var r=n.Ca.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;Gn(n),On(n)}jn(n),Xe(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=et(S(n.ab,n),6e3));if(nn(n.i)<=1&&n.ka){try{n.ka()}catch(e){}n.ka=void 0}}else zn(n,11)}else if(!e.J&&n.g!=e||Gn(n),!O(t))for(s=n.Ca.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var a=i[3];null!=a&&(n.ma=a,n.h.info("VER="+n.ma));var o=i[4];null!=o&&(n.za=o,n.h.info("SVER="+n.za));var h,u,c,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=e.g;m&&(!(h=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(u=r.i).g&&(F(h,"spdy")||F(h,"quic")||F(h,"h2"))&&(u.j=u.l,u.g=new Set,u.h&&(sn(u,u.h),u.h=null)),!r.D||(c=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=c,Pt(r.F,r.D,c))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-e.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=e;(r=n).oa=Yn(r,r.H?r.la:null,r.W),g.J?(an(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(Tt(d),wt(d)),r.g=g):Bn(r),0<n.l.length&&Fn(n)}else"stop"!=i[0]&&"close"!=i[0]||zn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?zn(n,7):Ln(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Ye()}catch(e){}}function St(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(w(e)||"string"==typeof e)x(e,t,void 0);else{if(e.T&&"function"==typeof e.T)var n=e.T();else if(e.R&&"function"==typeof e.R)n=void 0;else if(w(e)||"string"==typeof e)for(var n=[],r=e.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,e)n[r++]=s;for(var s=(r=function(e){if(e.R&&"function"==typeof e.R)return e.R();if("string"==typeof e)return e.split("");if(w(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e)).length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}}function At(e,t){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof At)for(n=e.T(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function Dt(e){if(e.i!=e.g.length){for(var t=0,n=0;t<e.g.length;){var r=e.g[t];Ct(e.h,r)&&(e.g[n++]=r),t++}e.g.length=n}if(e.i!=e.g.length){for(var s={},n=t=0;t<e.g.length;)Ct(s,r=e.g[t])||(s[e.g[n++]=r]=1),t++;e.g.length=n}}function Ct(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(d=ut.prototype).setTimeout=function(e){this.P=e},d.gb=function(e){e=e.target;const t=this.L;t&&3==Cn(e)?t.l():this.Ia(e)},d.Ia=function(e){try{if(e==this.g)e:{var t=Cn(this.g),n=this.g.Da();this.g.ba();if(!(t<3)&&(3!=t||Q||this.g&&(this.h.h||this.g.ga()||kn(this.g)))){this.I||4!=t||7==n||Ye(),Tt(this);var r=this.g.ba();this.N=r;t:if(yt(this)){var s=kn(this.g);e="";var i=s.length,a=4==Cn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){It(this),Et(this);var o="";break t}this.h.i=new v.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){t:{if(this.g){var h,u=this.g;if((h=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!O(h)){var c=h;break t}}c=null}if(!(r=c)){this.i=!1,this.o=3,Xe(12),It(this),Et(this);break e}Ge(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,_t(this,r)}this.U?(vt(this,t,o),Q&&this.i&&3==t&&(je(this.V,this.W,"tick",this.fb),this.W.start())):(Ge(this.j,this.m,o,null),_t(this,o)),4==t&&It(this),this.i&&!this.I&&(4==t?Hn(this.l,this):(this.i=!1,wt(this)))}else 400==r&&0<o.indexOf("Unknown SID")?(this.o=3,Xe(12)):(this.o=0,Xe(13)),It(this),Et(this)}}}catch(e){}var l,d,f,g,m,p,y},d.fb=function(){var e,t;this.g&&(e=Cn(this.g),t=this.g.ga(),this.C<t.length&&(Tt(this),vt(this,e,t),this.i&&4!=e&&wt(this)))},d.cancel=function(){this.I=!0,It(this)},d.eb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(Ye(),Xe(17)),It(this),this.o=2,Et(this)):bt(this,this.Y-n)},(d=At.prototype).R=function(){Dt(this);for(var e=[],t=0;t<this.g.length;t++)e.push(this.h[this.g[t]]);return e},d.T=function(){return Dt(this),this.g.concat()},d.get=function(e,t){return Ct(this.h,e)?this.h[e]:t},d.set=function(e,t){Ct(this.h,e)||(this.i++,this.g.push(e)),this.h[e]=t},d.forEach=function(e,t){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);e.call(t,i,s,this)}};var kt=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Nt(e,t){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,e instanceof Nt?(this.g=void 0!==t?t:e.g,Rt(this,e.j),this.s=e.s,Lt(this,e.i),Ot(this,e.m),this.l=e.l,t=e.h,(n=new Ht).i=t.i,t.g&&(n.g=new At(t.g),n.h=t.h),Mt(this,n),this.o=e.o):e&&(n=String(e).match(kt))?(this.g=!!t,Rt(this,n[1]||"",!0),this.s=Vt(n[2]||""),Lt(this,n[3]||"",!0),Ot(this,n[4]),this.l=Vt(n[5]||"",!0),Mt(this,n[6]||"",!0),this.o=Vt(n[7]||"")):(this.g=!!t,this.h=new Ht(null,this.g))}function xt(e){return new Nt(e)}function Rt(e,t,n){e.j=n?Vt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Lt(e,t,n){e.i=n?Vt(t,!0):t}function Ot(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Mt(e,t,n){var r,s;t instanceof Ht?(e.h=t,r=e.h,(s=e.g)&&!r.j&&(Wt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(zt(this,t),Yt(this,n,e))},r)),r.j=s):(n||(t=Ut(t,$t)),e.h=new Ht(t,e.g))}function Pt(e,t,n){e.h.set(t,n)}function Ft(e){return Pt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Vt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Ut(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,qt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function qt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Nt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Ut(t,Bt,!0),":");var n=this.i;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Ut(t,Bt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&e.push("/"),e.push(Ut(n,"/"==n.charAt(0)?Kt:jt,!0))),(n=this.h.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Ut(n,Gt)),e.join("")};var Bt=/[#\/\?@]/g,jt=/[#\?:]/g,Kt=/[#\?]/g,$t=/[#\?@]/g,Gt=/#/g;function Ht(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Wt(n){n.g||(n.g=new At,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,s=e[n].indexOf("="),i=null;0<=s?(r=e[n].substring(0,s),i=e[n].substring(s+1)):r=e[n],t(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function zt(e,t){Wt(e),t=Jt(e,t),Ct(e.g.h,t)&&(e.i=null,e.h-=e.g.get(t).length,Ct((e=e.g).h,t)&&(delete e.h[t],e.i--,e.g.length>2*e.i&&Dt(e)))}function Qt(e,t){return Wt(e),t=Jt(e,t),Ct(e.g.h,t)}function Yt(e,t,n){zt(e,t),0<n.length&&(e.i=null,e.g.set(Jt(e,t),L(n)),e.h+=n.length)}function Jt(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(d=Ht.prototype).add=function(e,t){Wt(this),this.i=null,e=Jt(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},d.forEach=function(n,r){Wt(this),this.g.forEach(function(e,t){x(e,function(e){n.call(r,e,t,this)},this)},this)},d.T=function(){Wt(this);for(var e=this.g.R(),t=this.g.T(),n=[],r=0;r<t.length;r++)for(var s=e[r],i=0;i<s.length;i++)n.push(t[r]);return n},d.R=function(e){Wt(this);var t=[];if("string"==typeof e)Qt(this,e)&&(t=R(t,this.g.get(Jt(this,e))));else{e=this.g.R();for(var n=0;n<e.length;n++)t=R(t,e[n])}return t},d.set=function(e,t){return Wt(this),this.i=null,Qt(this,e=Jt(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},d.get=function(e,t){return e&&0<(e=this.R(e)).length?String(e[0]):t},d.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var e=[],t=this.g.T(),n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var a=s;""!==r[i]&&(a+="="+encodeURIComponent(String(r[i]))),e.push(a)}return this.i=e.join("&")};var Xt=class{constructor(e,t){this.h=e,this.g=t}};function Zt(e){this.l=e||10,e=v.PerformanceNavigationTiming?0<(e=v.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(v.g&&v.g.Ea&&v.g.Ea()&&v.g.Ea().Zb),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var en;function tn(e){return e.h||e.g&&e.g.size>=e.j}function nn(e){return e.h?1:e.g?e.g.size:0}function rn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function sn(e,t){e.g?e.g.add(t):e.h=t}function an(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function on(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return L(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function hn(){}function un(){this.g=new hn}function cn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function ln(e){this.l=e.$b||null,this.j=e.ib||!1}function dn(e,t){Se.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=fn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Zt.prototype.cancel=function(){if(this.i=on(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},hn.prototype.stringify=function(e){return v.JSON.stringify(e,void 0)},hn.prototype.parse=function(e){return v.JSON.parse(e,void 0)},D(ln,rt),ln.prototype.g=function(){return new dn(this.l,this.j)},ln.prototype.i=(en={},function(){return en}),D(dn,Se);var fn=0;function gn(e){e.j.read().then(e.Sa.bind(e)).catch(e.ha.bind(e))}function mn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,pn(e)}function pn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(d=dn.prototype).open=function(e,t){if(this.readyState!=fn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,pn(this)},d.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||v).fetch(new Request(this.B,t)).then(this.Va.bind(this),this.ha.bind(this))},d.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,mn(this)),this.readyState=fn},d.Va=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,pn(this)),this.g&&(this.readyState=3,pn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==v.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;gn(this)}else e.text().then(this.Ua.bind(this),this.ha.bind(this))},d.Sa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?mn:pn)(this),3==this.readyState&&gn(this))},d.Ua=function(e){this.g&&(this.response=this.responseText=e,mn(this))},d.Ta=function(e){this.g&&(this.response=e,mn(this))},d.ha=function(){this.g&&mn(this)},d.setRequestHeader=function(e,t){this.v.append(e,t)},d.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},d.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(dn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var yn=v.JSON.parse;function vn(e){Se.call(this),this.headers=new At,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=wn,this.K=this.L=!1}D(vn,Se);var wn="",bn=/^https?$/i,Tn=["POST","PUT"];function En(e){return"content-type"==e.toLowerCase()}function In(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,_n(e),An(e)}function _n(e){e.D||(e.D=!0,Ae(e,"complete"),Ae(e,"error"))}function Sn(e){if(e.h&&void 0!==p&&(!e.C[1]||4!=Cn(e)||2!=e.ba()))if(e.v&&4==Cn(e))Ve(e.Fa,0,e);else if(Ae(e,"readystatechange"),4==Cn(e)){e.h=!1;try{var t,n,r,s,i=e.ba();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break e;default:a=!1}if((t=a)||((n=0===i)&&(!(s=String(e.H).match(kt)[1]||null)&&v.self&&v.self.location&&(s=(r=v.self.location.protocol).substr(0,r.length-1)),n=!bn.test(s?s.toLowerCase():"")),t=n),t)Ae(e,"complete"),Ae(e,"success");else{e.m=6;try{var o=2<Cn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.ba()+"]",_n(e)}}finally{An(e)}}}function An(e,t){if(e.g){Dn(e);const n=e.g,r=e.C[0]?y:null;e.g=null,e.C=null,t||Ae(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Dn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(v.clearTimeout(e.A),e.A=null)}function Cn(e){return e.g?e.g.readyState:0}function kn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case wn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Nn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=function(e){let n="";return q(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Pt(e,t,n))}function xn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Rn(e){this.za=0,this.l=[],this.h=new $e,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=xn("failFast",!1,e),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=xn("baseRetryDelayMs",5e3,e),this.$a=xn("retryDelaySeedMs",1e4,e),this.Ya=xn("forwardChannelMaxRetries",2,e),this.ra=xn("forwardChannelRequestTimeoutMs",2e4,e),this.qa=e&&e.xmlHttpFactory||void 0,this.Ba=e&&e.Yb||!1,this.K=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.J="",this.i=new Zt(e&&e.concurrentRequestLimit),this.Ca=new un,this.ja=e&&e.fastHandshake||!1,this.Ra=e&&e.Wb||!1,e&&e.Aa&&this.h.Aa(),e&&e.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&e&&e.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!e||!1!==e.Xb}function Ln(e){var t,n;Mn(e),3==e.G&&(t=e.V++,Pt(n=xt(e.F),"SID",e.J),Pt(n,"RID",t),Pt(n,"TYPE","terminate"),Un(e,n),(t=new ut(e,e.h,t,void 0)).K=2,t.v=Ft(xt(n)),n=!1,!(n=v.navigator&&v.navigator.sendBeacon?v.navigator.sendBeacon(t.v.toString(),""):n)&&v.Image&&((new Image).src=t.v,n=!0),n||(t.g=Jn(t.l,null),t.g.ea(t.v)),t.F=Date.now(),wt(t)),Qn(e)}function On(e){e.g&&(Kn(e),e.g.cancel(),e.g=null)}function Mn(e){On(e),e.u&&(v.clearTimeout(e.u),e.u=null),Gn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&v.clearTimeout(e.m),e.m=null)}function Pn(e,t){e.l.push(new Xt(e.Za++,t)),3==e.G&&Fn(e)}function Fn(e){tn(e.i)||e.m||(e.m=!0,Re(e.Ha,e),e.C=0)}function Vn(e,t){var n=t?t.m:e.V++,r=xt(e.F);Pt(r,"SID",e.J),Pt(r,"RID",n),Pt(r,"AID",e.U),Un(e,r),e.o&&e.s&&Nn(r,e.o,e.s),n=new ut(e,e.h,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.l=t.D.concat(e.l)),t=qn(e,n,1e3),n.setTimeout(Math.round(.5*e.ra)+Math.round(.5*e.ra*Math.random())),sn(e.i,n),mt(n,r,t)}function Un(e,n){e.j&&St({},function(e,t){Pt(n,t,e)})}function qn(e,t,r){r=Math.min(e.l.length,r);var s=e.j?S(e.j.Oa,e.j,e):null;e:{var i=e.l;let n=-1;for(;;){const h=["count="+r];-1==n?0<r?(n=i[0].h,h.push("ofs="+n)):n=0:h.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=i[t].h,o=i[t].g;if((a-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(e,r,t){const s=t||"";try{St(e,function(e,t){let n=e;b(e)&&(n=Ce(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(o,h,"req"+a+"_")}catch(e){s&&s(o)}}if(e){s=h.join("&");break e}}}return e=e.l.splice(0,r),t.D=e,s}function Bn(e){e.g||e.u||(e.Y=1,Re(e.Ga,e),e.A=0)}function jn(e){return!(e.g||e.u||3<=e.A)&&(e.Y++,e.u=et(S(e.Ga,e),Wn(e,e.A)),e.A++,1)}function Kn(e){null!=e.B&&(v.clearTimeout(e.B),e.B=null)}function $n(e){e.g=new ut(e,e.h,"rpc",e.Y),null===e.o&&(e.g.H=e.s),e.g.O=0;var t=xt(e.oa);Pt(t,"RID","rpc"),Pt(t,"SID",e.J),Pt(t,"CI",e.N?"0":"1"),Pt(t,"AID",e.U),Un(e,t),Pt(t,"TYPE","xmlhttp"),e.o&&e.s&&Nn(t,e.o,e.s),e.K&&e.g.setTimeout(e.K);var n=e.g;e=e.la,n.K=1,n.v=Ft(xt(t)),n.s=null,n.U=!0,pt(n,e)}function Gn(e){null!=e.v&&(v.clearTimeout(e.v),e.v=null)}function Hn(e,t){var n,r,s,i=null;if(e.g==t){Gn(e),Kn(e),e.g=null;var a=2}else{if(!rn(e.i,t))return;i=t.D,an(e.i,t),a=1}if(e.I=t.N,0!=e.G)if(t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Ae(a=ze(),new Ze(a,i)),Fn(e)):Bn(e);else if(3==(n=t.o)||0==n&&0<e.I||(1!=a||(s=t,nn((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=et(S(r.Ha,r,s),Wn(r,r.C)),r.C++,0))))&&(2!=a||!jn(e)))switch(i&&0<i.length&&(t=e.i,t.i=t.i.concat(i)),n){case 1:zn(e,5);break;case 4:zn(e,10);break;case 3:zn(e,6);break;default:zn(e,2)}}function Wn(e,t){let n=e.Pa+Math.floor(Math.random()*e.$a);return e.j||(n*=2),n*t}function zn(e,t){var n,r;e.h.info("Error code "+t),2==t?(n=null,e.j&&(n=null),r=S(e.jb,e),n||(n=new Nt("//www.google.com/images/cleardot.gif"),v.location&&"http"==v.location.protocol||Rt(n,"https"),Ft(n)),function(e,t){var n=new $e;if(v.Image){const r=new Image;r.onload=A(cn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=A(cn,n,r,"TestLoadImage: error",!1,t),r.onabort=A(cn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=A(cn,n,r,"TestLoadImage: timeout",!1,t),v.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):Xe(2),e.G=0,e.j&&e.j.va(t),Qn(e),Mn(e)}function Qn(e){e.G=0,e.I=-1,e.j&&(0==on(e.i).length&&0==e.l.length||(e.i.i.length=0,L(e.l),e.l.length=0),e.j.ua())}function Yn(e,t,n){let r=(o=n)instanceof Nt?xt(o):new Nt(o,void 0);var s,i,a,o,h;return""!=r.i?(t&&Lt(r,t+"."+r.i),Ot(r,r.m)):(h=v.location,r=(s=h.protocol,i=t?t+"."+h.hostname:h.hostname,a=+h.port,o=n,h=new Nt(null,void 0),s&&Rt(h,s),i&&Lt(h,i),a&&Ot(h,a),o&&(h.l=o),h)),e.aa&&q(e.aa,function(e,t){Pt(r,t,e)}),t=e.D,n=e.sa,t&&n&&Pt(r,t,n),Pt(r,"VER",e.ma),Un(e,r),r}function Jn(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ba&&!e.qa?new vn(new ln({ib:!0})):new vn(e.qa)).L=e.H,t}function Xn(){}function Zn(){if(W&&!(10<=Number(re)))throw Error("Environmental error: no available transport.")}function er(e,t){Se.call(this),this.g=new Rn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.P=e,(e=t&&t.httpHeadersOverwriteParam)&&!O(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!O(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new rr(this)}function tr(e){at.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function nr(){ot.call(this),this.status=1}function rr(e){this.g=e}(d=vn.prototype).ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||lt).g(),this.C=this.u?st(this.u):st(lt),this.g.onreadystatechange=S(this.Fa,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void In(this,e)}e=n||"";const s=new At(this.headers);r&&St(r,function(e,t){s.set(t,e)}),r=function(t){e:{var n=En,r=t.length,s="string"==typeof t?t.split(""):t;for(let e=0;e<r;e++)if(e in s&&n.call(void 0,s[e],e,t)){n=e;break e}n=-1}return n<0?null:"string"==typeof t?t.charAt(n):t[n]}(s.T()),n=v.FormData&&e instanceof v.FormData,0<=N(Tn,t)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(e,t){this.g.setRequestHeader(t,e)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Dn(this),0<this.B&&((this.K=(i=this.g,W&&ne()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=S(this.pa,this)):this.A=Ve(this.pa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){In(this,e)}var i},d.pa=function(){void 0!==p&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Ae(this,"timeout"),this.abort(8))},d.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Ae(this,"complete"),Ae(this,"abort"),An(this))},d.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),An(this,!0)),vn.Z.M.call(this)},d.Fa=function(){this.s||(this.F||this.v||this.l?Sn(this):this.cb())},d.cb=function(){Sn(this)},d.ba=function(){try{return 2<Cn(this)?this.g.status:-1}catch(e){return-1}},d.ga=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},d.Qa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),yn(t)}},d.Da=function(){return this.m},d.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(d=Rn.prototype).ma=8,d.G=1,d.hb=function(e){try{this.h.info("Origin Trials invoked: "+e)}catch(e){}},d.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const i=new ut(this,this.h,t,void 0);let e=this.s;if(this.P&&(e?(e=B(e),K(e,this.P)):e=this.P),null===this.o&&(i.H=e),this.ja)e:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.l.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=qn(this,i,n),Pt(r=xt(this.F),"RID",t),Pt(r,"CVER",22),this.D&&Pt(r,"X-HTTP-Session-Id",this.D),Un(this,r),this.o&&e&&Nn(r,this.o,e),sn(this.i,i),this.Ra&&Pt(r,"TYPE","init"),this.ja?(Pt(r,"$req",n),Pt(r,"SID","null"),i.$=!0,mt(i,r,null)):mt(i,r,n),this.G=2}}else 3==this.G&&(t?Vn(this,t):0==this.l.length||tn(this.i)||Vn(this))},d.Ga=function(){var e;this.u=null,$n(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(e=2*this.O,this.h.info("BP detection timer enabled: "+e),this.B=et(S(this.bb,this),e))},d.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,Xe(10),On(this),$n(this))},d.ab=function(){null!=this.v&&(this.v=null,On(this),jn(this),Xe(19))},d.jb=function(e){e?(this.h.info("Successfully pinged google.com"),Xe(2)):(this.h.info("Failed to ping google.com"),Xe(1))},(d=Xn.prototype).xa=function(){},d.wa=function(){},d.va=function(){},d.ua=function(){},d.Oa=function(){},Zn.prototype.g=function(e,t){return new er(e,t)},D(er,Se),er.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;e.Wa&&(e.h.info("Origin Trials enabled."),Re(S(e.hb,e,t))),Xe(0),e.W=t,e.aa=n||{},e.N=e.X,e.F=Yn(e,null,e.W),Fn(e)},er.prototype.close=function(){Ln(this.g)},er.prototype.u=function(e){var t;"string"==typeof e?((t={}).__data__=e,Pn(this.g,t)):this.v?((t={}).__data__=Ce(e),Pn(this.g,t)):Pn(this.g,e)},er.prototype.M=function(){this.g.j=null,delete this.j,Ln(this.g),delete this.g,er.Z.M.call(this)},D(tr,at),D(nr,ot),D(rr,Xn),rr.prototype.xa=function(){Ae(this.g,"a")},rr.prototype.wa=function(e){Ae(this.g,new tr(e))},rr.prototype.va=function(e){Ae(this.g,new nr)},rr.prototype.ua=function(){Ae(this.g,"b")},Zn.prototype.createWebChannel=Zn.prototype.g,er.prototype.send=er.prototype.u,er.prototype.open=er.prototype.m,tt.NO_ERROR=0,tt.TIMEOUT=8,tt.HTTP_ERROR=6,nt.COMPLETE="complete",(it.EventType=g).OPEN="a",g.CLOSE="b",g.ERROR="c",g.MESSAGE="d",Se.prototype.listen=Se.prototype.N,vn.prototype.listenOnce=vn.prototype.O,vn.prototype.getLastError=vn.prototype.La,vn.prototype.getLastErrorCode=vn.prototype.Da,vn.prototype.getStatus=vn.prototype.ba,vn.prototype.getResponseJson=vn.prototype.Qa,vn.prototype.getResponseText=vn.prototype.ga,vn.prototype.send=vn.prototype.ea;var sr,ir=ze,ar=tt,or=nt,hr=He,ur=10,cr=11,lr=ln,dr=it,fr=vn;const gr="@firebase/firestore";class mr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}mr.UNAUTHENTICATED=new mr(null),mr.GOOGLE_CREDENTIALS=new mr("google-credentials-uid"),mr.FIRST_PARTY=new mr("first-party-uid"),mr.MOCK_USER=new mr("mock-user");let pr="9.6.1";const yr=new class{constructor(e){this.name=e,this._logLevel=h,this._logHandler=c,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?o[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function vr(){return yr.logLevel}function wr(e,...t){var n;yr.logLevel<=l.DEBUG&&(n=t.map(Er),yr.debug(`Firestore (${pr}): ${e}`,...n))}function br(e,...t){var n;yr.logLevel<=l.ERROR&&(n=t.map(Er),yr.error(`Firestore (${pr}): ${e}`,...n))}function Tr(e,...t){var n;yr.logLevel<=l.WARN&&(n=t.map(Er),yr.warn(`Firestore (${pr}): ${e}`,...n))}function Er(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Ir(e="Unexpected state"){var t=`FIRESTORE (${pr}) INTERNAL ASSERTION FAILED: `+e;throw br(t),new Error(t)}function _r(e){e||Ir()}const Sr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ar extends Error{constructor(e,t){super(t),this.code=e,this.message=t,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Dr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Cr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class kr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(mr.UNAUTHENTICATED))}shutdown(){}}class Nr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class xr{constructor(e){this.t=e,this.currentUser=mr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Dr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Dr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{wr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(wr("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Dr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(wr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(_r("string"==typeof e.accessToken),new Cr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return _r(null===e||"string"==typeof e),new mr(e)}}class Rr{constructor(e,t,n){this.type="FirstParty",this.user=mr.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);var r=e.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Lr{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new Rr(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable(()=>t(mr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Or{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Mr{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null}start(t,n){this.o=e=>{t.enqueueRetryable(()=>(e=>(null!=e.error&&wr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`),n(e.token)))(e))};const r=e=>{wr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit(e=>r(e)),setTimeout(()=>{var e;this.appCheck||((e=this.g.getImmediate({optional:!0}))?r(e):wr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(_r("string"==typeof e.token),new Or(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Pr{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.p(e),this.T=e=>t.writeSequenceNumber(e))}p(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.T&&this.T(e),e}}Pr.I=-1;class Fr{static A(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function Vr(e,t){return e<t?-1:t<e?1:0}function Ur(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function qr(e){return e+"\0"}class Br{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Ar(Sr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Ar(Sr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Ar(Sr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Ar(Sr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Br.fromMillis(Date.now())}static fromDate(e){return Br.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Br(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Vr(this.nanoseconds,e.nanoseconds):Vr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class jr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new jr(e)}static min(){return new jr(new Br(0,0))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Kr(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function $r(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Gr(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Hr{constructor(e,t,n){void 0===t?t=0:t>e.length&&Ir(),void 0===n?n=e.length-t:n>e.length-t&&Ir(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Hr.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Hr?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Wr extends Hr{construct(e,t,n){return new Wr(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new Wr(t)}static emptyPath(){return new Wr([])}}const zr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Qr extends Hr{construct(e,t,n){return new Qr(e,t,n)}static isValidIdentifier(e){return zr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!Qr.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Qr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Ar(Sr.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Ar(Sr.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Ar(Sr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new Ar(Sr.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Qr(t)}static emptyPath(){return new Qr([])}}class Yr{constructor(e){(this.fields=e).sort(Qr.comparator)}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Ur(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class Jr{constructor(e){this.binaryString=e}static fromBase64String(e){var t=atob(e);return new Jr(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Jr(t)}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Vr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Jr.EMPTY_BYTE_STRING=new Jr("");const Xr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Zr(t){if(_r(!!t),"string"!=typeof t)return{seconds:es(t.seconds),nanos:es(t.nanos)};{let e=0;var n=Xr.exec(t);_r(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function es(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ts(e){return"string"==typeof e?Jr.fromBase64String(e):Jr.fromUint8Array(e)}function ns(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function rs(e){var t=Zr(e.mapValue.fields.__local_write_time__.timestampValue);return new Br(t.seconds,t.nanos)}function ss(e){return null==e}function is(e){return 0===e&&1/e==-1/0}function as(e){return"number"==typeof e&&Number.isInteger(e)&&!is(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}class os{constructor(e){this.path=e}static fromPath(e){return new os(Wr.fromString(e))}static fromName(e){return new os(Wr.fromString(e).popFirst(5))}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}isEqual(e){return null!==e&&0===Wr.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Wr.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new os(new Wr(e.slice()))}}function hs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ns(e)?4:10:Ir()}function us(r,s){var e,t,n=hs(r);if(n!==hs(s))return!1;switch(n){case 0:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return rs(r).isEqual(rs(s));case 3:return function(e){if("string"==typeof r.timestampValue&&"string"==typeof e.timestampValue&&r.timestampValue.length===e.timestampValue.length)return r.timestampValue===e.timestampValue;var t=Zr(r.timestampValue),n=Zr(e.timestampValue);return t.seconds===n.seconds&&t.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return t=s,ts(r.bytesValue).isEqual(ts(t.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return e=s,es((t=r).geoPointValue.latitude)===es(e.geoPointValue.latitude)&&es(t.geoPointValue.longitude)===es(e.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return es(e.integerValue)===es(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=es(e.doubleValue),r=es(t.doubleValue);return n===r?is(n)===is(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return Ur(r.arrayValue.values||[],s.arrayValue.values||[],us);case 10:return function(e){const t=e.mapValue.fields||{},n=s.mapValue.fields||{};if(Kr(t)!==Kr(n))return!1;for(const e in t)if(t.hasOwnProperty(e)&&(void 0===n[e]||!us(t[e],n[e])))return!1;return!0}(r);default:return Ir()}}function cs(e,t){return void 0!==(e.values||[]).find(e=>us(e,t))}function ls(e,t){var n,r,s,i,a=hs(e),o=hs(t);if(a!==o)return Vr(a,o);switch(a){case 0:return 0;case 1:return Vr(e.booleanValue,t.booleanValue);case 2:return r=t,s=es(e.integerValue||e.doubleValue),i=es(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return ds(e.timestampValue,t.timestampValue);case 4:return ds(rs(e),rs(t));case 5:return Vr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ts(e),r=ts(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=Vr(n[s],r[s]);if(0!==t)return t}return Vr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(i=Vr(es(n.latitude),es(r.latitude)))?i:Vr(es(n.longitude),es(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=ls(n[s],r[s]);if(t)return t}return Vr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=Vr(r[o],i[o]);if(0!==t)return t;var a=ls(n[r[o]],s[i[o]]);if(0!==a)return a}return Vr(r.length,i.length)}(e.mapValue,t.mapValue);default:throw Ir()}}function ds(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Vr(e,t);var n=Zr(e),r=Zr(t),s=Vr(n.seconds,r.seconds);return 0!==s?s:Vr(n.nanos,r.nanos)}function fs(e){return function i(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Zr(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?ts(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,os.fromName(t).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=i(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${i(e.fields[s])}`;return n+"}"}(e.mapValue):Ir();var t}(e)}function gs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function ms(e){return e&&"integerValue"in e}function ps(e){return!!e&&"arrayValue"in e}function ys(e){return e&&"nullValue"in e}function vs(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function ws(e){return e&&"mapValue"in e}function bs(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return $r(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=bs(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=bs(t.arrayValue.values[e]);return r}return Object.assign({},t)}class Ts{constructor(e){this.value=e}static empty(){return new Ts({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!ws(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=bs(t)}setAll(e){let n=Qr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=bs(e):s.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(e){const t=this.field(e.popLast());ws(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return us(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];ws(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){$r(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ts(bs(this.value))}}class Es{constructor(e,t,n,r,s){this.key=e,this.documentType=t,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(e){return new Es(e,0,jr.min(),Ts.empty(),0)}static newFoundDocument(e,t,n){return new Es(e,1,t,n,0)}static newNoDocument(e,t){return new Es(e,2,t,Ts.empty(),0)}static newUnknownDocument(e,t){return new Es(e,3,t,Ts.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ts.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ts.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Es&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}clone(){return new Es(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Is{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.R=null}}function _s(e,t=null,n=[],r=[],s=null,i=null,a=null){return new Is(e,t,n,r,s,i,a)}function Ss(e){const t=e;if(null===t.R){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function(e){return e.field.canonicalString()+e.op.toString()+fs(e.value)}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),ss(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=Vs(t.startAt)),t.endAt&&(e+="|ub:",e+=Vs(t.endAt)),t.R=e}return t.R}function As(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let a=0;a<e.orderBy.length;a++)if(n=e.orderBy[a],r=t.orderBy[a],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r,s,i;if(e.filters.length!==t.filters.length)return!1;for(let o=0;o<e.filters.length;o++)if(s=e.filters[o],i=t.filters[o],s.op!==i.op||!s.field.isEqual(i.field)||!us(s.value,i.value))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Bs(e.startAt,t.startAt)&&Bs(e.endAt,t.endAt)}function Ds(e){return os.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class Cs extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.P(e,t,n):new ks(e,t,n):"array-contains"===t?new Ls(e,n):"in"===t?new Os(e,n):"not-in"===t?new Ms(e,n):"array-contains-any"===t?new Ps(e,n):new Cs(e,t,n)}static P(e,t,n){return new("in"===t?Ns:xs)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.v(ls(t,this.value)):null!==t&&hs(this.value)===hs(t)&&this.v(ls(t,this.value))}v(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Ir()}}V(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class ks extends Cs{constructor(e,t,n){super(e,t,n),this.key=os.fromName(n.referenceValue)}matches(e){var t=os.comparator(e.key,this.key);return this.v(t)}}class Ns extends Cs{constructor(e,t){super(e,"in",t),this.keys=Rs(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class xs extends Cs{constructor(e,t){super(e,"not-in",t),this.keys=Rs(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function Rs(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>os.fromName(e.referenceValue))}class Ls extends Cs{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return ps(t)&&cs(t.arrayValue,this.value)}}class Os extends Cs{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&cs(this.value.arrayValue,t)}}class Ms extends Cs{constructor(e,t){super(e,"not-in",t)}matches(e){if(cs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!cs(this.value.arrayValue,t)}}class Ps extends Cs{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!ps(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>cs(this.value.arrayValue,e))}}class Fs{constructor(e,t){this.position=e,this.before=t}}function Vs(e){return`${e.before?"b":"a"}:${e.position.map(e=>fs(e)).join(",")}`}class Us{constructor(e,t="asc"){this.field=e,this.dir=t}}function qs(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],a=e.position[s];if(r=i.field.isKeyField()?os.comparator(os.fromName(a.referenceValue),n.key):ls(a,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return e.before?r<=0:r<0}function Bs(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.before!==t.before||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!us(e.position[n],t.position[n]))return!1;return!0}class js{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this.S=null,this.D=null,this.startAt,this.endAt}}function Ks(e,t,n,r,s,i,a,o){return new js(e,t,n,r,s,i,a,o)}function $s(e){return new js(e)}function Gs(e){return!ss(e.limit)&&"F"===e.limitType}function Hs(e){return!ss(e.limit)&&"L"===e.limitType}function Ws(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function zs(e){for(const t of e.filters)if(t.V())return t.field;return null}function Qs(e){return null!==e.collectionGroup}function Ys(t){const n=t;if(null===n.S){n.S=[];const t=zs(n),e=Ws(n);if(null!==t&&null===e)t.isKeyField()||n.S.push(new Us(t)),n.S.push(new Us(Qr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.S.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.S.push(new Us(Qr.keyField(),t))}}}return n.S}function Js(e){const t=e;if(!t.D)if("F"===t.limitType)t.D=_s(t.path,t.collectionGroup,Ys(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Ys(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Us(s.field,t))}var n=t.endAt?new Fs(t.endAt.position,!t.endAt.before):null,r=t.startAt?new Fs(t.startAt.position,!t.startAt.before):null;t.D=_s(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.D}function Xs(e,t,n){return new js(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Zs(e,t){return As(Js(e),Js(t))&&e.limitType===t.limitType}function ei(e){return`${Ss(Js(e))}|lt:${e.limitType}`}function ti(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>{return`${(t=e).field.canonicalString()} ${t.op} ${fs(t.value)}`;var t}).join(", ")}]`),ss(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: "+Vs(e.startAt)),e.endAt&&(t+=", endAt: "+Vs(e.endAt)),`Target(${t})`}(Js(e))}; limitType=${e.limitType})`}function ni(n,e){return e.isFoundDocument()&&(t=n,s=(r=e).key.path,null!==t.collectionGroup?r.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(s):os.isDocumentKey(t.path)?t.path.isEqual(s):t.path.isImmediateParentOf(s))&&function(e){for(const t of n.explicitOrderBy)if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(t=e,(!(e=n).startAt||qs(e.startAt,Ys(e),t))&&(!e.endAt||!qs(e.endAt,Ys(e),t)));var t,r,s}function ri(s){return(e,t)=>{let n=!1;for(const r of Ys(s)){const s=function(e,s,t){var n=e.field.isKeyField()?os.comparator(s.key,t.key):function(e,t){var n=s.data.field(e),r=t.data.field(e);return null!==n&&null!==r?ls(n,r):Ir()}(e.field,t);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return Ir()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function si(e,t){if(e.C){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:is(t)?"-0":t}}function ii(e){return{integerValue:""+e}}function ai(e,t){return as(t)?ii(t):si(e,t)}class oi{constructor(){this._=void 0}}function hi(e,t){return e instanceof gi?ms(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class ui extends oi{}class ci extends oi{constructor(e){super(),this.elements=e}}function li(e,t){const n=pi(t);for(const t of e.elements)n.some(e=>us(e,t))||n.push(t);return{arrayValue:{values:n}}}class di extends oi{constructor(e){super(),this.elements=e}}function fi(e,t){let n=pi(t);for(const t of e.elements)n=n.filter(e=>!us(e,t));return{arrayValue:{values:n}}}class gi extends oi{constructor(e,t){super(),this.k=e,this.N=t}}function mi(e){return es(e.integerValue||e.doubleValue)}function pi(e){return ps(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class yi{constructor(e,t){this.field=e,this.transform=t}}class vi{constructor(e,t){this.version=e,this.transformResults=t}}class wi{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new wi}static exists(e){return new wi(void 0,e)}static updateTime(e){return new wi(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function bi(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Ti{}function Ei(e,t,n){e instanceof Ai?function(e,t,n){const r=e.value.clone(),s=ki(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Di?function(e,t,n){if(!bi(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=ki(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Ci(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function Ii(e,t,n){e instanceof Ai?function(e,t,n){if(bi(e.precondition,t)){const r=e.value.clone(),s=Ni(e.fieldTransforms,n,t);r.setAll(s),t.convertToFoundDocument(Si(t),r).setHasLocalMutations()}}(e,t,n):e instanceof Di?function(e,t,n){if(bi(e.precondition,t)){const r=Ni(e.fieldTransforms,n,t),s=t.data;s.setAll(Ci(e)),s.setAll(r),t.convertToFoundDocument(Si(t),s).setHasLocalMutations()}}(e,t,n):(t=t,bi(e.precondition,t)&&t.convertToNoDocument(jr.min()))}function _i(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Ur(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof ci&&t instanceof ci||e instanceof di&&t instanceof di?Ur(e.elements,t.elements,us):e instanceof gi&&t instanceof gi?us(e.N,t.N):e instanceof ui&&t instanceof ui)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}function Si(e){return e.isFoundDocument()?e.version:jr.min()}class Ai extends Ti{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Di extends Ti{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Ci(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function ki(e,t,n){const r=new Map;_r(e.length===n.length);for(let c=0;c<n.length;c++){var s=e[c],i=s.transform,a=t.data.field(s.field);r.set(s.field,(o=i,h=a,u=n[c],o instanceof ci?li(o,h):o instanceof di?fi(o,h):u))}var o,h,u;return r}function Ni(e,t,n){const r=new Map;for(const u of e){const e=u.transform,c=n.data.field(u.field);r.set(u.field,(s=e,i=c,a=t,h=o=void 0,s instanceof ui?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof ci?li(s,i):s instanceof di?fi(s,i):(o=hi(s=s,i),h=mi(o)+mi(s.N),ms(o)&&ms(s.N)?ii(h):si(s.k,h))))}var s,i,a,o,h;return r}class xi extends Ti{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}}class Ri extends Ti{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}}class Li{constructor(e){this.count=e}}function Oi(e){switch(e){default:return Ir(),0;case Sr.CANCELLED:case Sr.UNKNOWN:case Sr.DEADLINE_EXCEEDED:case Sr.RESOURCE_EXHAUSTED:case Sr.INTERNAL:case Sr.UNAVAILABLE:case Sr.UNAUTHENTICATED:return;case Sr.INVALID_ARGUMENT:case Sr.NOT_FOUND:case Sr.ALREADY_EXISTS:case Sr.PERMISSION_DENIED:case Sr.FAILED_PRECONDITION:case Sr.ABORTED:case Sr.OUT_OF_RANGE:case Sr.UNIMPLEMENTED:case Sr.DATA_LOSS:return 1}}function Mi(e){if(void 0===e)return br("GRPC error has no .code"),Sr.UNKNOWN;switch(e){case sr.OK:return Sr.OK;case sr.CANCELLED:return Sr.CANCELLED;case sr.UNKNOWN:return Sr.UNKNOWN;case sr.DEADLINE_EXCEEDED:return Sr.DEADLINE_EXCEEDED;case sr.RESOURCE_EXHAUSTED:return Sr.RESOURCE_EXHAUSTED;case sr.INTERNAL:return Sr.INTERNAL;case sr.UNAVAILABLE:return Sr.UNAVAILABLE;case sr.UNAUTHENTICATED:return Sr.UNAUTHENTICATED;case sr.INVALID_ARGUMENT:return Sr.INVALID_ARGUMENT;case sr.NOT_FOUND:return Sr.NOT_FOUND;case sr.ALREADY_EXISTS:return Sr.ALREADY_EXISTS;case sr.PERMISSION_DENIED:return Sr.PERMISSION_DENIED;case sr.FAILED_PRECONDITION:return Sr.FAILED_PRECONDITION;case sr.ABORTED:return Sr.ABORTED;case sr.OUT_OF_RANGE:return Sr.OUT_OF_RANGE;case sr.UNIMPLEMENTED:return Sr.UNIMPLEMENTED;case sr.DATA_LOSS:return Sr.DATA_LOSS;default:return Ir()}}(nt=sr=sr||{})[nt.OK=0]="OK",nt[nt.CANCELLED=1]="CANCELLED",nt[nt.UNKNOWN=2]="UNKNOWN",nt[nt.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",nt[nt.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",nt[nt.NOT_FOUND=5]="NOT_FOUND",nt[nt.ALREADY_EXISTS=6]="ALREADY_EXISTS",nt[nt.PERMISSION_DENIED=7]="PERMISSION_DENIED",nt[nt.UNAUTHENTICATED=16]="UNAUTHENTICATED",nt[nt.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",nt[nt.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",nt[nt.ABORTED=10]="ABORTED",nt[nt.OUT_OF_RANGE=11]="OUT_OF_RANGE",nt[nt.UNIMPLEMENTED=12]="UNIMPLEMENTED",nt[nt.INTERNAL=13]="INTERNAL",nt[nt.UNAVAILABLE=14]="UNAVAILABLE",nt[nt.DATA_LOSS=15]="DATA_LOSS";class Pi{constructor(e,t){this.comparator=e,this.root=t||Vi.EMPTY}insert(e,t){return new Pi(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Vi.BLACK,null,null))}remove(e){return new Pi(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Vi.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Fi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Fi(this.root,e,this.comparator,!1)}getReverseIterator(){return new Fi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Fi(this.root,e,this.comparator,!0)}}class Fi{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Vi{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Vi.RED,this.left=null!=r?r:Vi.EMPTY,this.right=null!=s?s:Vi.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Vi(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Vi.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Vi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,Vi.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,Vi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ir();if(this.right.isRed())throw Ir();var e=this.left.check();if(e!==this.right.check())throw Ir();return e+(this.isRed()?0:1)}}Vi.EMPTY=null,Vi.RED=!0,Vi.BLACK=!1,Vi.EMPTY=new class{constructor(){this.size=0}get key(){throw Ir()}get value(){throw Ir()}get color(){throw Ir()}get left(){throw Ir()}get right(){throw Ir()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Vi(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ui{constructor(e){this.comparator=e,this.data=new Pi(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new qi(this.data.getIterator())}getIteratorFrom(e){return new qi(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof Ui))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new Ui(this.comparator);return t.data=e,t}}class qi{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Bi=new Pi(os.comparator);const ji=new Pi(os.comparator);const Ki=new Pi(os.comparator);const $i=new Ui(os.comparator);function Gi(...e){let t=$i;for(const n of e)t=t.add(n);return t}const Hi=new Ui(Vr);class Wi{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,zi.createSynthesizedTargetChangeForCurrentChange(e,t)),new Wi(jr.min(),n,Hi,Bi,Gi())}}class zi{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new zi(Jr.EMPTY_BYTE_STRING,t,Gi(),Gi(),Gi())}}class Qi{constructor(e,t,n,r){this.$=e,this.removedTargetIds=t,this.key=n,this.F=r}}class Yi{constructor(e,t){this.targetId=e,this.O=t}}class Ji{constructor(e,t,n=Jr.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Xi{constructor(){this.M=0,this.L=ta(),this.B=Jr.EMPTY_BYTE_STRING,this.U=!1,this.q=!0}get current(){return this.U}get resumeToken(){return this.B}get K(){return 0!==this.M}get j(){return this.q}W(e){0<e.approximateByteSize()&&(this.q=!0,this.B=e)}G(){let n=Gi(),r=Gi(),s=Gi();return this.L.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:Ir()}}),new zi(this.B,this.U,n,r,s)}H(){this.q=!1,this.L=ta()}J(e,t){this.q=!0,this.L=this.L.insert(e,t)}Y(e){this.q=!0,this.L=this.L.remove(e)}X(){this.M+=1}Z(){--this.M}tt(){this.q=!0,this.U=!0}}class Zi{constructor(e){this.et=e,this.nt=new Map,this.st=Bi,this.it=ea(),this.rt=new Ui(Vr)}ot(e){for(const t of e.$)e.F&&e.F.isFoundDocument()?this.at(t,e.F):this.ct(t,e.key,e.F);for(const n of e.removedTargetIds)this.ct(n,e.key,e.F)}ut(n){this.forEachTarget(n,e=>{const t=this.ht(e);switch(n.state){case 0:this.lt(e)&&t.W(n.resumeToken);break;case 1:t.Z(),t.K||t.H(),t.W(n.resumeToken);break;case 2:t.Z(),t.K||this.removeTarget(e);break;case 3:this.lt(e)&&(t.tt(),t.W(n.resumeToken));break;case 4:this.lt(e)&&(this.ft(e),t.W(n.resumeToken));break;default:Ir()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.nt.forEach((e,t)=>{this.lt(t)&&n(t)})}dt(e){const t=e.targetId,n=e.O.count,r=this.wt(t);if(r){const e=r.target;if(Ds(e))if(0===n){const n=new os(e.path);this.ct(t,n,Es.newNoDocument(n,jr.min()))}else _r(1===n);else this._t(t)!==n&&(this.ft(t),this.rt=this.rt.add(t))}}gt(r){const s=new Map;this.nt.forEach((e,t)=>{var n=this.wt(t);if(n){if(e.current&&Ds(n.target)){const s=new os(n.target.path);null!==this.st.get(s)||this.yt(t,s)||this.ct(t,s,Es.newNoDocument(s,r))}e.j&&(s.set(t,e.G()),e.H())}});let i=Gi();this.it.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.wt(e);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(e))});var e=new Wi(r,s,this.rt,this.st,i);return this.st=Bi,this.it=ea(),this.rt=new Ui(Vr),e}at(e,t){var n;this.lt(e)&&(n=this.yt(e,t.key)?2:0,this.ht(e).J(t.key,n),this.st=this.st.insert(t.key,t),this.it=this.it.insert(t.key,this.Tt(t.key).add(e)))}ct(e,t,n){if(this.lt(e)){const r=this.ht(e);this.yt(e,t)?r.J(t,1):r.Y(t),this.it=this.it.insert(t,this.Tt(t).delete(e)),n&&(this.st=this.st.insert(t,n))}}removeTarget(e){this.nt.delete(e)}_t(e){var t=this.ht(e).G();return this.et.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}X(e){this.ht(e).X()}ht(e){let t=this.nt.get(e);return t||(t=new Xi,this.nt.set(e,t)),t}Tt(e){let t=this.it.get(e);return t||(t=new Ui(Vr),this.it=this.it.insert(e,t)),t}lt(e){var t=null!==this.wt(e);return t||wr("WatchChangeAggregator","Detected inactive target",e),t}wt(e){var t=this.nt.get(e);return t&&t.K?null:this.et.Et(e)}ft(t){this.nt.set(t,new Xi),this.et.getRemoteKeysForTarget(t).forEach(e=>{this.ct(t,e,null)})}yt(e,t){return this.et.getRemoteKeysForTarget(e).has(t)}}function ea(){return new Pi(os.comparator)}function ta(){return new Pi(os.comparator)}const na={asc:"ASCENDING",desc:"DESCENDING"},ra={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class sa{constructor(e,t){this.databaseId=e,this.C=t}}function ia(e,t){return e.C?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function aa(e,t){return e.C?t.toBase64():t.toUint8Array()}function oa(e){return _r(!!e),jr.fromTimestamp((t=Zr(e),new Br(t.seconds,t.nanos)));var t}function ha(e,t){return e=e,new Wr(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function ua(e){var t=Wr.fromString(e);return _r(ka(t)),t}function ca(e,t){return ha(e.databaseId,t.path)}function la(e,t){const n=ua(t);if(n.get(1)!==e.databaseId.projectId)throw new Ar(Sr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Ar(Sr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new os(ma(n))}function da(e,t){return ha(e.databaseId,t)}function fa(e){var t=ua(e);return 4===t.length?Wr.emptyPath():ma(t)}function ga(e){return new Wr(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ma(e){return _r(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function pa(e,t,n){return{name:ca(e,t),fields:n.value.mapValue.fields}}function ya(e,t,n){const r=la(e,t.name),s=oa(t.updateTime),i=new Ts({mapValue:{fields:t.fields}}),a=Es.newFoundDocument(r,s,i);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function va(e,t){let n;if(t instanceof Ai)n={update:pa(e,t.key,t.value)};else if(t instanceof xi)n={delete:ca(e,t.key)};else if(t instanceof Di)n={update:pa(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Ri))return Ir();n={verify:ca(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof ui)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof ci)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof di)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof gi)return{fieldPath:e.field.canonicalString(),increment:t.N};throw Ir()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,ia(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:Ir()),n;var r}function wa(t,n){const e=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?wi.updateTime(oa(s.updateTime)):void 0!==s.exists?wi.exists(s.exists):wi.none():wi.none(),r=n.updateTransforms?n.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)_r("REQUEST_TIME"===t.setToServerValue),n=new ui;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new ci(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new di(e)}else"increment"in t?n=new gi(e,t.increment):Ir();var r=Qr.fromServerFormat(t.fieldPath);return new yi(r,n)}(t,e)):[];var s;if(n.update){n.update.name;var i=la(t,n.update.name),a=new Ts({mapValue:{fields:n.update.fields}});if(n.updateMask){const t=function(){const e=n.updateMask.fieldPaths||[];return new Yr(e.map(e=>Qr.fromServerFormat(e)))}();return new Di(i,a,t,e,r)}return new Ai(i,a,e,r)}if(n.delete){const r=la(t,n.delete);return new xi(r,e)}if(n.verify){const r=la(t,n.verify);return new Ri(r,e)}return Ir()}function ba(e,t){return{documents:[da(e,t.path)]}}function Ta(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=da(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=da(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length){var t=e.map(e=>function(e){if("=="===e.op){if(vs(e.value))return{unaryFilter:{field:Sa(e.field),op:"IS_NAN"}};if(ys(e.value))return{unaryFilter:{field:Sa(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(vs(e.value))return{unaryFilter:{field:Sa(e.field),op:"IS_NOT_NAN"}};if(ys(e.value))return{unaryFilter:{field:Sa(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Sa(e.field),op:(t=e.op,ra[t]),value:e.value}};var t}(e));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:Sa(e.field),direction:(e=e.dir,na[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=t.limit,e.C||ss(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt=Ia(t.startAt)),t.endAt&&(n.structuredQuery.endAt=Ia(t.endAt)),n}function Ea(e){let t=fa(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){_r(1===r);const l=n.from[0];l.allDescendants?s=l.collectionId:t=t.child(l.collectionId)}let i=[];n.where&&(i=function t(e){return e?void 0!==e.unaryFilter?[Ca(e)]:void 0!==e.fieldFilter?[Da(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(e=>t(e)).reduce((e,t)=>e.concat(t)):Ir():[]}(n.where));let a=[];n.orderBy&&(a=n.orderBy.map(e=>function(e){return new Us(Aa(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let o=null;var h;n.limit&&(o=(e=n.limit,ss(h="object"==typeof e?e.value:e)?null:h));let u=null;n.startAt&&(u=_a(n.startAt));let c=null;return n.endAt&&(c=_a(n.endAt)),Ks(t,s,a,i,o,"F",u,c)}function Ia(e){return{before:e.before,values:e.position}}function _a(e){var t=!!e.before,n=e.values||[];return new Fs(n,t)}function Sa(e){return{fieldPath:e.canonicalString()}}function Aa(e){return Qr.fromServerFormat(e.fieldPath)}function Da(e){return Cs.create(Aa(e.fieldFilter.field),function(){switch(e.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ir()}}(),e.fieldFilter.value)}function Ca(e){switch(e.unaryFilter.op){case"IS_NAN":var t=Aa(e.unaryFilter.field);return Cs.create(t,"==",{doubleValue:NaN});case"IS_NULL":t=Aa(e.unaryFilter.field);return Cs.create(t,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=Aa(e.unaryFilter.field);return Cs.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=Aa(e.unaryFilter.field);return Cs.create(n,"!=",{nullValue:"NULL_VALUE"});default:return Ir()}}function ka(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function Na(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=xa(t)),t=function(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const r=e.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return xa(t)}function xa(e){return e+""}function Ra(t){const n=t.length;if(_r(2<=n),2===n)return _r(""===t.charAt(0)&&""===t.charAt(1)),Wr.emptyPath();const r=n-2,s=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>r)&&Ir(),t.charAt(n+1)){case"":const r=t.substring(a,n);let e;0===i.length?e=r:(i+=r,e=i,i=""),s.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:Ir()}a=n+2}return new Wr(s)}class La{constructor(e,t){this.seconds=e,this.nanoseconds=t}}class Oa{constructor(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n}}Oa.store="owner",Oa.key="owner";class Ma{constructor(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}}Ma.store="mutationQueues",Ma.keyPath="userId";class Pa{constructor(e,t,n,r,s){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}Pa.store="mutations",Pa.keyPath="batchId",Pa.userMutationsIndex="userMutationsIndex",Pa.userMutationsKeyPath=["userId","batchId"];class Fa{constructor(){}static prefixForUser(e){return[e]}static prefixForPath(e,t){return[e,Na(t)]}static key(e,t,n){return[e,Na(t),n]}}Fa.store="documentMutations",Fa.PLACEHOLDER=new Fa;class Va{constructor(e,t){this.path=e,this.readTime=t}}class Ua{constructor(e,t){this.path=e,this.version=t}}class qa{constructor(e,t,n,r,s,i){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}qa.store="remoteDocuments",qa.readTimeIndex="readTimeIndex",qa.readTimeIndexPath="readTime",qa.collectionReadTimeIndex="collectionReadTimeIndex",qa.collectionReadTimeIndexPath=["parentPath","readTime"];class Ba{constructor(e){this.byteSize=e}}Ba.store="remoteDocumentGlobal",Ba.key="remoteDocumentGlobalKey";class ja{constructor(e,t,n,r,s,i,a){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=a}}ja.store="targets",ja.keyPath="targetId",ja.queryTargetsIndexName="queryTargetsIndex",ja.queryTargetsKeyPath=["canonicalId","targetId"];class Ka{constructor(e,t,n){this.targetId=e,this.path=t,this.sequenceNumber=n}}Ka.store="targetDocuments",Ka.keyPath=["targetId","path"],Ka.documentTargetsIndex="documentTargetsIndex",Ka.documentTargetsKeyPath=["path","targetId"];class $a{constructor(e,t,n,r){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}$a.key="targetGlobalKey",$a.store="targetGlobal";class Ga{constructor(e,t){this.collectionId=e,this.parent=t}}Ga.store="collectionParents",Ga.keyPath=["collectionId","parent"];class Ha{constructor(e,t,n,r){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=r}}Ha.store="clientMetadata",Ha.keyPath="clientId";class Wa{constructor(e,t,n){this.bundleId=e,this.createTime=t,this.version=n}}Wa.store="bundles",Wa.keyPath="bundleId";class za{constructor(e,t,n){this.name=e,this.readTime=t,this.bundledQuery=n}}za.store="namedQueries",za.keyPath="name";const Qa=[Ma.store,Pa.store,Fa.store,qa.store,ja.store,Oa.store,$a.store,Ka.store,Ha.store,Ba.store,Ga.store,Wa.store,za.store],Ya="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Ja{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}class Xa{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&Ir(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new Xa((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof Xa?t:Xa.resolve(t)}catch(e){return Xa.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):Xa.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):Xa.reject(t)}static resolve(n){return new Xa((e,t)=>{e(n)})}static reject(n){return new Xa((e,t)=>{t(n)})}static waitFor(e){return new Xa((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=Xa.resolve(!1);for(const n of e)t=t.next(e=>e?Xa.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}}class Za{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.It=new Dr,this.transaction.oncomplete=()=>{this.It.resolve()},this.transaction.onabort=()=>{e.error?this.It.reject(new no(n,e.error)):this.It.resolve()},this.transaction.onerror=e=>{var t=oo(e.target.error);this.It.reject(new no(n,t))}}static open(e,t,n,r){try{return new Za(t,e.transaction(r,n))}catch(e){throw new no(t,e)}}get At(){return this.It.promise}abort(e){e&&this.It.reject(e),this.aborted||(wr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(e){var t=this.transaction.objectStore(e);return new so(t)}}class eo{constructor(e,t,n){this.name=e,this.version=t,this.Rt=n,12.2===eo.Pt(f())&&br("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return wr("SimpleDb","Removing database:",e),io(window.indexedDB.deleteDatabase(e)).toPromise()}static bt(){if("object"!=typeof indexedDB)return!1;if(eo.vt())return!0;const e=f(),t=eo.Pt(e),n=0<t&&t<10,r=eo.Vt(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static vt(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.St)}static Dt(e,t){return e.store(t)}static Pt(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Vt(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Ct(i){return this.db||(wr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{var t=e.target.result;n(t)},s.onblocked=()=>{r(new no(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new Ar(Sr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new Ar(Sr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new no(i,t))},s.onupgradeneeded=e=>{wr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.Rt.Nt(t,s.transaction,e.oldVersion,this.version).next(()=>{wr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.kt&&(this.db.onversionchange=e=>this.kt(e)),this.db}xt(t){this.kt=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.Ct(e);const t=Za.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).catch(e=>(t.abort(e),Xa.reject(e))).toPromise();return i.catch(()=>{}),await t.At,i}catch(e){const t="FirebaseError"!==e.name&&i<3;if(wr("SimpleDb","Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class to{constructor(e){this.$t=e,this.Ft=!1,this.Ot=null}get isDone(){return this.Ft}get Mt(){return this.Ot}set cursor(e){this.$t=e}done(){this.Ft=!0}Lt(e){this.Ot=e}delete(){return io(this.$t.delete())}}class no extends Ar{constructor(e,t){super(Sr.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ro(e){return"IndexedDbTransactionError"===e.name}class so{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(wr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(wr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),io(n)}add(e){return wr("SimpleDb","ADD",this.store.name,e,e),io(this.store.add(e))}get(t){return io(this.store.get(t)).next(e=>(wr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return wr("SimpleDb","DELETE",this.store.name,e),io(this.store.delete(e))}count(){return wr("SimpleDb","COUNT",this.store.name),io(this.store.count())}Bt(e,t){const n=this.cursor(this.options(e,t)),r=[];return this.Ut(n,(e,t)=>{r.push(t)}).next(()=>r)}qt(e,t){wr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Kt=!1;var r=this.cursor(n);return this.Ut(r,(e,t,n)=>n.delete())}jt(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.Ut(r,t)}Qt(s){const e=this.cursor({});return new Xa((n,r)=>{e.onerror=e=>{var t=oo(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?s(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}Ut(e,i){const a=[];return new Xa((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new to(t),r=i(t.primaryKey,t.value,n);if(r instanceof Xa){const e=r.catch(e=>(n.done(),Xa.reject(e)));a.push(e)}n.isDone?s():null===n.Mt?t.continue():t.continue(n.Mt)}else s()}}).next(()=>Xa.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Kt?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function io(e){return new Xa((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=oo(e.target.error);r(t)}})}let ao=!1;function oo(e){const t=eo.Pt(f());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Ar("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ao||(ao=!0,setTimeout(()=>{throw e},0)),e}}return e}class ho extends Ja{constructor(e,t){super(),this.Wt=e,this.currentSequenceNumber=t}}function uo(e,t){var n=e;return eo.Dt(n.Wt,t)}class co{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(e.key)&&Ei(s,e,n[r])}}applyToLocalView(e){for(const t of this.baseMutations)t.key.isEqual(e.key)&&Ii(t,e,this.localWriteTime);for(const n of this.mutations)n.key.isEqual(e.key)&&Ii(n,e,this.localWriteTime)}applyToLocalDocumentSet(r){this.mutations.forEach(e=>{const t=r.get(e.key),n=t;this.applyToLocalView(n),t.isValidDocument()||n.convertToNoDocument(jr.min())})}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Gi())}isEqual(e){return this.batchId===e.batchId&&Ur(this.mutations,e.mutations,(e,t)=>_i(e,t))&&Ur(this.baseMutations,e.baseMutations,(e,t)=>_i(e,t))}}class lo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){_r(e.mutations.length===n.length);let r=Ki;var s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new lo(e,t,n,r)}}class fo{constructor(e,t,n,r,s=jr.min(),i=jr.min(),a=Jr.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a}withSequenceNumber(e){return new fo(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new fo(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new fo(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class go{constructor(e){this.Gt=e}}function mo(e,t){if(t.document)return ya(e.Gt,t.document,!!t.hasCommittedMutations);if(t.noDocument){const e=os.fromSegments(t.noDocument.path),n=bo(t.noDocument.readTime),r=Es.newNoDocument(e,n);return t.hasCommittedMutations?r.setHasCommittedMutations():r}if(t.unknownDocument){const e=os.fromSegments(t.unknownDocument.path),s=bo(t.unknownDocument.version);return Es.newUnknownDocument(e,s)}return Ir()}function po(e,t,n){var r=yo(n),s=t.key.path.popLast().toArray();if(t.isFoundDocument()){const i={name:ca(n=e.Gt,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:ia(n,e.version.toTimestamp())},a=t.hasCommittedMutations;return new qa(null,null,i,a,r,s)}if(t.isNoDocument()){const o=t.key.path.toArray(),i=wo(t.version),h=t.hasCommittedMutations;return new qa(null,new Va(o,i),null,h,r,s)}if(t.isUnknownDocument()){const o=t.key.path.toArray(),i=wo(t.version);return new qa(new Ua(o,i),null,null,!0,r,s)}return Ir()}function yo(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function vo(e){var t=new Br(e[0],e[1]);return jr.fromTimestamp(t)}function wo(e){var t=e.toTimestamp();return new La(t.seconds,t.nanoseconds)}function bo(e){var t=new Br(e.seconds,e.nanoseconds);return jr.fromTimestamp(t)}function To(t,e){const n=(e.baseMutations||[]).map(e=>wa(t.Gt,e));for(let i=0;i<e.mutations.length-1;++i){const n=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const r=e.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map(e=>wa(t.Gt,e)),s=Br.fromMillis(e.localWriteTimeMs);return new co(e.batchId,s,n,r)}function Eo(e){var t,n=bo(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?bo(e.lastLimboFreeSnapshotVersion):jr.min();let s;return s=void 0!==e.query.documents?(_r(1===(t=e.query).documents.length),Js($s(fa(t.documents[0])))):Js(Ea(e.query)),new fo(s,e.targetId,0,e.lastListenSequenceNumber,n,r,Jr.fromBase64String(e.resumeToken))}function Io(e,t){var n=wo(t.snapshotVersion),r=wo(t.lastLimboFreeSnapshotVersion),s=(Ds(t.target)?ba:Ta)(e.Gt,t.target),i=t.resumeToken.toBase64();return new ja(t.targetId,Ss(t.target),n,i,t.sequenceNumber,r,s)}function _o(e){var t=Ea({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Xs(t,t.limit,"L"):t}class So{getBundleMetadata(e,t){return Ao(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:bo(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return Ao(e).put({bundleId:(n=t).id,createTime:wo(oa(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Do(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:_o(t.bundledQuery),readTime:bo(t.readTime)};var t})}saveNamedQuery(e,t){return Do(e).put({name:(t=t).name,readTime:wo(oa(t.readTime)),bundledQuery:t.bundledQuery})}}function Ao(e){return uo(e,Wa.store)}function Do(e){return uo(e,za.store)}class Co{constructor(){this.zt=new ko}addToCollectionParentIndex(e,t){return this.zt.add(t),Xa.resolve()}getCollectionParents(e,t){return Xa.resolve(this.zt.getEntries(t))}}class ko{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Ui(Wr.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Ui(Wr.comparator)).toArray()}}class No{constructor(){this.Ht=new ko}addToCollectionParentIndex(e,t){if(this.Ht.has(t))return Xa.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Ht.add(t)});r={collectionId:n,parent:Na(r)};return xo(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[qr(n),""],!1,!0);return xo(e).Bt(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Ra(t.parent))}return r})}}function xo(e){return uo(e,Ga.store)}const Ro={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Lo{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Lo(e,Lo.DEFAULT_COLLECTION_PERCENTILE,Lo.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Oo(e,t,n){const r=e.store(Pa.store),s=e.store(Fa.store),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const h=r.jt({range:a},(e,t,n)=>(o++,n.delete()));i.push(h.next(()=>{_r(1===o)}));const u=[];for(const e of n.mutations){const r=Fa.key(t,e.key.path,n.batchId);i.push(s.delete(r)),u.push(e.key)}return Xa.waitFor(i).next(()=>u)}function Mo(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Ir();t=e.noDocument}return JSON.stringify(t).length}Lo.DEFAULT_COLLECTION_PERCENTILE=10,Lo.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Lo.DEFAULT=new Lo(41943040,Lo.DEFAULT_COLLECTION_PERCENTILE,Lo.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Lo.DISABLED=new Lo(-1,0,0);class Po{constructor(e,t,n,r){this.userId=e,this.k=t,this.Jt=n,this.referenceDelegate=r,this.Yt={}}static Xt(e,t,n,r){_r(""!==e.uid);var s=e.isAuthenticated()?e.uid:"";return new Po(s,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Vo(e).jt({index:Pa.userMutationsIndex,range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(c,l,d,f){const g=Uo(c),m=Vo(c);return m.add({}).next(e=>{_r("number"==typeof e);const t=new co(e,l,d,f),n=(s=this.k,i=this.userId,a=t,o=a.baseMutations.map(e=>va(s.Gt,e)),h=a.mutations.map(e=>va(s.Gt,e)),new Pa(i,a.batchId,a.localWriteTime.toMillis(),o,h)),r=[];var s,i,a,o,h;let u=new Ui((e,t)=>Vr(e.canonicalString(),t.canonicalString()));for(const c of f){const l=Fa.key(this.userId,c.key.path,e);u=u.add(c.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Fa.PLACEHOLDER))}return u.forEach(e=>{r.push(this.Jt.addToCollectionParentIndex(c,e))}),c.addOnCommittedListener(()=>{this.Yt[e]=t.keys()}),Xa.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Vo(e).get(t).next(e=>e?(_r(e.userId===this.userId),To(this.k,e)):null)}Zt(e,n){return this.Yt[n]?Xa.resolve(this.Yt[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.Yt[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Vo(e).jt({index:Pa.userMutationsIndex,range:n},(e,t,n)=>{t.userId===this.userId&&(_r(t.batchId>=r),s=To(this.k,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Vo(e).jt({index:Pa.userMutationsIndex,range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Vo(e).Bt(Pa.userMutationsIndex,t).next(e=>e.map(e=>To(this.k,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=Fa.prefixForPath(this.userId,o.path),t=IDBKeyRange.lowerBound(e),h=[];return Uo(a).jt({range:t},(e,t,n)=>{var[r,s,i]=e,s=Ra(s);if(r===this.userId&&o.path.isEqual(s))return Vo(a).get(i).next(e=>{if(!e)throw Ir();_r(e.userId===this.userId),h.push(To(this.k,e))});n.done()}).next(()=>h)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new Ui(Vr);const n=[];return e.forEach(a=>{var e=Fa.prefixForPath(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=Uo(t).jt({range:e},(e,t,n)=>{var[r,s,i]=e,s=Ra(s);r===this.userId&&a.path.isEqual(s)?o=o.add(i):n.done()});n.push(e)}),Xa.waitFor(n).next(()=>this.te(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=Fa.prefixForPath(this.userId,a),r=IDBKeyRange.lowerBound(n);let h=new Ui(Vr);return Uo(e).jt({range:r},(e,t,n)=>{var[r,s,i]=e,s=Ra(s);r===this.userId&&a.isPrefixOf(s)?s.length===o&&(h=h.add(i)):n.done()}).next(()=>this.te(e,h))}te(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Vo(t).get(e).next(e=>{if(null===e)throw Ir();_r(e.userId===this.userId),n.push(To(this.k,e))}))}),Xa.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return Oo(t.Wt,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.ee(n.batchId)}),Xa.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}ee(e){delete this.Yt[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return Xa.resolve();const t=IDBKeyRange.lowerBound(Fa.prefixForUser(this.userId)),r=[];return Uo(n).jt({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Ra(e[1]);r.push(t)}else n.done()}).next(()=>{_r(0===r.length)})})}containsKey(e,t){return Fo(e,this.userId,t)}ne(e){return qo(e).get(this.userId).next(e=>e||new Ma(this.userId,-1,""))}}function Fo(e,i,t){const n=Fa.prefixForPath(i,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Uo(e).jt({range:r,Kt:!0},(e,t,n)=>{var[r,s]=e;r===i&&s===a&&(o=!0),n.done()}).next(()=>o)}function Vo(e){return uo(e,Pa.store)}function Uo(e){return uo(e,Fa.store)}function qo(e){return uo(e,Ma.store)}class Bo{constructor(e){this.se=e}next(){return this.se+=2,this.se}static ie(){return new Bo(0)}static re(){return new Bo(-1)}}class jo{constructor(e,t){this.referenceDelegate=e,this.k=t}allocateTargetId(n){return this.oe(n).next(e=>{const t=new Bo(e.highestTargetId);return e.highestTargetId=t.next(),this.ae(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.oe(e).next(e=>jr.fromTimestamp(new Br(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.oe(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.oe(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.ae(t,e)))}addTargetData(t,n){return this.ce(t,n).next(()=>this.oe(t).next(e=>(e.targetCount+=1,this.ue(n,e),this.ae(t,e))))}updateTargetData(e,t){return this.ce(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Ko(t).delete(e.targetId)).next(()=>this.oe(t)).next(e=>(_r(0<e.targetCount),--e.targetCount,this.ae(t,e)))}removeTargets(r,s,i){let a=0;const o=[];return Ko(r).jt((e,t)=>{var n=Eo(t);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>Xa.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Ko(e).jt((e,t)=>{var n=Eo(t);r(n)})}oe(e){return $o(e).get($a.key).next(e=>(_r(null!==e),e))}ae(e,t){return $o(e).put($a.key,t)}ce(e,t){return Ko(e).put(Io(this.k,t))}ue(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.oe(e).next(e=>e.targetCount)}getTargetData(e,s){var t=Ss(s),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return Ko(e).jt({range:t,index:ja.queryTargetsIndexName},(e,t,n)=>{var r=Eo(t);As(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const s=[],i=Go(n);return e.forEach(e=>{var t=Na(e.path);s.push(i.put(new Ka(r,t))),s.push(this.referenceDelegate.addReference(n,r,e))}),Xa.waitFor(s)}removeMatchingKeys(n,e,r){const s=Go(n);return Xa.forEach(e,e=>{var t=Na(e.path);return Xa.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Go(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Go(e);let s=Gi();return r.jt({range:n,Kt:!0},(e,t,n)=>{var r=Ra(e[1]),r=new os(r);s=s.add(r)}).next(()=>s)}containsKey(e,t){var n=Na(t.path),n=IDBKeyRange.bound([n],[qr(n)],!1,!0);let r=0;return Go(e).jt({index:Ka.documentTargetsIndex,Kt:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}Et(e,t){return Ko(e).get(t).next(e=>e?Eo(e):null)}}function Ko(e){return uo(e,ja.store)}function $o(e){return uo(e,$a.store)}function Go(e){return uo(e,Ka.store)}async function Ho(e){if(e.code!==Sr.FAILED_PRECONDITION||e.message!==Ya)throw e;wr("LocalStore","Unexpectedly lost primary lease")}function Wo([e,t],[n,r]){var s=Vr(e,n);return 0===s?Vr(t,r):s}class zo{constructor(e){this.he=e,this.buffer=new Ui(Wo),this.le=0}fe(){return++this.le}de(e){var t=[e,this.fe()];if(this.buffer.size<this.he)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Wo(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Qo{constructor(e,t){this.garbageCollector=e,this.asyncQueue=t,this.we=!1,this._e=null}start(e){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.me(e)}stop(){this._e&&(this._e.cancel(),this._e=null)}get started(){return null!==this._e}me(e){var t=this.we?3e5:6e4;wr("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this._e=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this._e=null,this.we=!0;try{await e.collectGarbage(this.garbageCollector)}catch(e){ro(e)?wr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await Ho(e)}await this.me(e)})}}class Yo{constructor(e,t){this.ge=e,this.params=t}calculateTargetCount(e,t){return this.ge.ye(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return Xa.resolve(Pr.I);const n=new zo(t);return this.ge.forEachTarget(e,e=>n.de(e.sequenceNumber)).next(()=>this.ge.pe(e,e=>n.de(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.ge.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.ge.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(wr("LruGarbageCollector","Garbage collection skipped; disabled"),Xa.resolve(Ro)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(wr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ro):this.Te(t,n))}getCacheSize(e){return this.ge.getCacheSize(e)}Te(t,n){let r,s,i,a,o,h,u;const c=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(wr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,h=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(u=Date.now(),vr()<=l.DEBUG&&wr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-c}ms\n\tDetermined least recently used ${s} in `+(o-a)+"ms\n"+`\tRemoved ${i} targets in `+(h-o)+"ms\n"+`\tRemoved ${e} documents in `+(u-h)+"ms\n"+`Total Duration: ${u-c}ms`),Xa.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class Jo{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new Yo(e,t))}ye(e){const n=this.Ee(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Ee(e){let t=0;return this.pe(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}pe(e,n){return this.Ie(e,(e,t)=>n(t))}addReference(e,t,n){return Xo(e,n)}removeReference(e,t,n){return Xo(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Xo(e,t)}Ae(t,n){let r=!1;return qo(t).Qt(e=>Fo(t,e,n).next(e=>(e&&(r=!0),Xa.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Ie(n,(t,e)=>{if(e<=r){const r=this.Ae(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t),Go(n).delete([0,Na(t.path)])))});i.push(r)}}).next(()=>Xa.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Xo(e,t)}Ie(e,r){const t=Go(e);let s,i=Pr.I;return t.jt({index:Ka.documentTargetsIndex},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==Pr.I&&r(new os(Ra(s)),i),i=n,s=t):i=Pr.I}).next(()=>{i!==Pr.I&&r(new os(Ra(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Xo(e,t){return Go(e).put((t=t,e=e.currentSequenceNumber,new Ka(0,Na(t.path),e)))}class Zo{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={}}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){const e=this.mapKeyFn(t),r=this.inner[e];if(void 0!==r){for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n])}else this.inner[e]=[[t,n]]}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1}forEach(r){$r(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return Gr(this.inner)}}class eh{constructor(){this.changes=new Zo(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}getReadTime(e){var t=this.changes.get(e);return t?t.readTime:jr.min()}addEntry(e,t){this.assertNotApplied(),this.changes.set(e.key,{document:e,readTime:t})}removeEntry(e,t=null){this.assertNotApplied(),this.changes.set(e,{document:Es.newInvalidDocument(e),readTime:t})}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?Xa.resolve(n.document):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class th{constructor(e,t){this.k=e,this.Jt=t}addEntry(e,t,n){return sh(e).put(ih(t),n)}removeEntry(e,t){const n=sh(e),r=ih(t);return n.delete(r)}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Re(t,e)))}getEntry(e,t){return sh(e).get(ih(t)).next(e=>this.Pe(t,e))}be(e,t){return sh(e).get(ih(t)).next(e=>({document:this.Pe(t,e),size:Mo(e)}))}getEntries(e,t){let r=Bi;return this.ve(e,t,(e,t)=>{var n=this.Pe(e,t);r=r.insert(e,n)}).next(()=>r)}Ve(e,t){let r=Bi,s=new Pi(os.comparator);return this.ve(e,t,(e,t)=>{var n=this.Pe(e,t);r=r.insert(e,n),s=s.insert(e,Mo(t))}).next(()=>({documents:r,Se:s}))}ve(e,t,s){if(t.isEmpty())return Xa.resolve();const n=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),i=t.getIterator();let a=i.getNext();return sh(e).jt({range:n},(e,t,n)=>{for(var r=os.fromSegments(e);a&&os.comparator(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.Lt(a.path.toArray()):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,s,t){let i=Bi;const a=s.path.length+1,n={};if(t.isEqual(jr.min())){const e=s.path.toArray();n.range=IDBKeyRange.lowerBound(e)}else{const e=s.path.toArray(),i=yo(t);n.range=IDBKeyRange.lowerBound([e,i],!0),n.index=qa.collectionReadTimeIndex}return sh(e).jt(n,(e,t,n)=>{var r;e.length===a&&(r=mo(this.k,t),s.path.isPrefixOf(r.key.path)?ni(s,r)&&(i=i.insert(r.key,r)):n.done())}).next(()=>i)}newChangeBuffer(e){return new nh(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return rh(e).get(Ba.key).next(e=>(_r(!!e),e))}Re(e,t){return rh(e).put(Ba.key,t)}Pe(e,t){if(t){const e=mo(this.k,t);if(!e.isNoDocument()||!e.version.isEqual(jr.min()))return e}return Es.newInvalidDocument(e)}}class nh extends eh{constructor(e,t){super(),this.De=e,this.trackRemovals=t,this.Ce=new Zo(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,h=new Ui((e,t)=>Vr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Ce.get(e);if(t.document.isValidDocument()){var r=po(this.De.k,t.document,this.getReadTime(e));h=h.add(e.path.popLast());var s=Mo(r);o+=s-n,a.push(this.De.addEntry(i,e,r))}else if(o-=n,this.trackRemovals){const o=po(this.De.k,Es.newNoDocument(e,jr.min()),this.getReadTime(e));a.push(this.De.addEntry(i,e,o))}else a.push(this.De.removeEntry(i,e))}),h.forEach(e=>{a.push(this.De.Jt.addToCollectionParentIndex(i,e))}),a.push(this.De.updateMetadata(i,o)),Xa.waitFor(a)}getFromCache(e,t){return this.De.be(e,t).next(e=>(this.Ce.set(t,e.size),e.document))}getAllFromCache(e,t){return this.De.Ve(e,t).next(({documents:e,Se:t})=>(t.forEach((e,t)=>{this.Ce.set(e,t)}),e))}}function rh(e){return uo(e,Ba.store)}function sh(e){return uo(e,qa.store)}function ih(e){return e.path.toArray()}class ah{constructor(e){this.k=e}Nt(t,n,e,r){_r(e<r&&0<=e&&r<=11);const s=new Za("createOrUpgrade",n);var i;e<1&&1<=r&&(t.createObjectStore(Oa.store),(i=t).createObjectStore(Ma.store,{keyPath:Ma.keyPath}),i.createObjectStore(Pa.store,{keyPath:Pa.keyPath,autoIncrement:!0}).createIndex(Pa.userMutationsIndex,Pa.userMutationsKeyPath,{unique:!0}),i.createObjectStore(Fa.store),oh(t),t.createObjectStore(qa.store));let a=Xa.resolve();return e<3&&3<=r&&(0!==e&&((i=t).deleteObjectStore(Ka.store),i.deleteObjectStore(ja.store),i.deleteObjectStore($a.store),oh(t)),a=a.next(()=>function(){const e=s.store($a.store),t=new $a(0,0,jr.min().toTimestamp(),0);return e.put($a.key,t)}())),e<4&&4<=r&&(0!==e&&(a=a.next(()=>function(r,s){return s.store(Pa.store).Bt().next(e=>{r.deleteObjectStore(Pa.store),r.createObjectStore(Pa.store,{keyPath:Pa.keyPath,autoIncrement:!0}).createIndex(Pa.userMutationsIndex,Pa.userMutationsKeyPath,{unique:!0});const t=s.store(Pa.store),n=e.map(e=>t.put(e));return Xa.waitFor(n)})}(t,s))),a=a.next(()=>{t.createObjectStore(Ha.store,{keyPath:Ha.keyPath})})),e<5&&5<=r&&(a=a.next(()=>this.Ne(s))),e<6&&6<=r&&(a=a.next(()=>(t.createObjectStore(Ba.store),this.ke(s)))),e<7&&7<=r&&(a=a.next(()=>this.xe(s))),e<8&&8<=r&&(a=a.next(()=>this.$e(t,s))),e<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges"),function(){const e=n.objectStore(qa.store);e.createIndex(qa.readTimeIndex,qa.readTimeIndexPath,{unique:!1}),e.createIndex(qa.collectionReadTimeIndex,qa.collectionReadTimeIndexPath,{unique:!1})}()})),e<10&&10<=r&&(a=a.next(()=>this.Fe(s))),e<11&&11<=r&&(a=a.next(()=>{t.createObjectStore(Wa.store,{keyPath:Wa.keyPath}),t.createObjectStore(za.store,{keyPath:za.keyPath})})),a}ke(t){let n=0;return t.store(qa.store).jt((e,t)=>{n+=Mo(t)}).next(()=>{var e=new Ba(n);return t.store(Ba.store).put(Ba.key,e)})}Ne(r){const e=r.store(Ma.store),t=r.store(Pa.store);return e.Bt().next(e=>Xa.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.Bt(Pa.userMutationsIndex,e).next(e=>Xa.forEach(e,e=>{_r(e.userId===n.userId);var t=To(this.k,e);return Oo(r,n.userId,t).next(()=>{})}))}))}xe(e){const a=e.store(Ka.store),t=e.store(qa.store);return e.store($a.store).get($a.key).next(s=>{const i=[];return t.jt((e,t)=>{const n=new Wr(e),r=[0,Na(n)];i.push(a.get(r).next(e=>e?Xa.resolve():(e=>a.put(new Ka(0,Na(e),s.highestListenSequenceNumber)))(n)))}).next(()=>Xa.waitFor(i))})}$e(e,t){e.createObjectStore(Ga.store,{keyPath:Ga.keyPath});const n=t.store(Ga.store),r=new ko,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Na(r)})}};return t.store(qa.store).jt({Kt:!0},(e,t)=>{const n=new Wr(e);return s(n.popLast())}).next(()=>t.store(Fa.store).jt({Kt:!0},([,e],t)=>{const n=Ra(e);return s(n.popLast())}))}Fe(e){const r=e.store(ja.store);return r.jt((e,t)=>{var n=Eo(t),n=Io(this.k,n);return r.put(n)})}}function oh(e){e.createObjectStore(Ka.store,{keyPath:Ka.keyPath}).createIndex(Ka.documentTargetsIndex,Ka.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(ja.store,{keyPath:ja.keyPath}).createIndex(ja.queryTargetsIndexName,ja.queryTargetsKeyPath,{unique:!0}),e.createObjectStore($a.store)}const hh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class uh{constructor(e,t,n,r,s,i,a,o,h,u){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Oe=s,this.window=i,this.document=a,this.Me=h,this.Le=u,this.Be=null,this.Ue=!1,this.isPrimary=!1,this.networkEnabled=!0,this.qe=null,this.inForeground=!1,this.Ke=null,this.je=null,this.Qe=Number.NEGATIVE_INFINITY,this.We=e=>Promise.resolve(),!uh.bt())throw new Ar(Sr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Jo(this,r),this.Ge=t+"main",this.k=new go(o),this.ze=new eo(this.Ge,11,new ah(this.k)),this.He=new jo(this.referenceDelegate,this.k),this.Jt=new No,this.Je=(t=this.k,o=this.Jt,new th(t,o)),this.Ye=new So,this.window&&this.window.localStorage?this.Xe=this.window.localStorage:(this.Xe=null,!1===u&&br("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ze().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Ar(Sr.FAILED_PRECONDITION,hh);return this.tn(),this.en(),this.nn(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.He.getHighestSequenceNumber(e))}).then(e=>{this.Be=new Pr(e,this.Me)}).then(()=>{this.Ue=!0}).catch(e=>(this.ze&&this.ze.close(),Promise.reject(e)))}sn(t){return this.We=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ze.xt(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Oe.enqueueAndForget(async()=>{this.started&&await this.Ze()}))}Ze(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>lh(t).put(new Ha(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.rn(t).next(e=>{e||(this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.We(!1)))})}).next(()=>this.on(t)).next(e=>this.isPrimary&&!e?this.an(t).next(()=>!1):!!e&&this.cn(t).next(()=>!0))).catch(e=>{if(ro(e))return wr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return wr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Oe.enqueueRetryable(()=>this.We(e)),this.isPrimary=e})}rn(e){return ch(e).get(Oa.key).next(e=>Xa.resolve(this.un(e)))}hn(e){return lh(e).delete(this.clientId)}async ln(){if(this.isPrimary&&!this.fn(this.Qe,18e5)){this.Qe=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=uo(e,Ha.store);return r.Bt().next(e=>{const t=this.dn(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return Xa.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Xe)for(const t of e)this.Xe.removeItem(this.wn(t.clientId))}}nn(){this.je=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ze().then(()=>this.ln()).then(()=>this.nn()))}un(e){return!!e&&e.ownerId===this.clientId}on(t){return this.Le?Xa.resolve(!0):ch(t).get(Oa.key).next(e=>{if(null!==e&&this.fn(e.leaseTimestampMs,5e3)&&!this._n(e.ownerId)){if(this.un(e)&&this.networkEnabled)return!0;if(!this.un(e)){if(!e.allowTabSynchronization)throw new Ar(Sr.FAILED_PRECONDITION,hh);return!1}}return!(!this.networkEnabled||!this.inForeground)||lh(t).Bt().next(e=>void 0===this.dn(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&wr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Ue=!1,this.mn(),this.je&&(this.je.cancel(),this.je=null),this.gn(),this.yn(),await this.ze.runTransaction("shutdown","readwrite",[Oa.store,Ha.store],e=>{const t=new ho(e,Pr.I);return this.an(t).next(()=>this.hn(t))}),this.ze.close(),this.pn()}dn(e,t){return e.filter(e=>this.fn(e.updateTimeMs,t)&&!this._n(e.clientId))}Tn(){return this.runTransaction("getActiveClients","readonly",e=>lh(e).Bt().next(e=>this.dn(e,18e5).map(e=>e.clientId)))}get started(){return this.Ue}getMutationQueue(e){return Po.Xt(e,this.k,this.Jt,this.referenceDelegate)}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getIndexManager(){return this.Jt}getBundleCache(){return this.Ye}runTransaction(t,n,r){wr("IndexedDbPersistence","Starting transaction:",t);let s;return this.ze.runTransaction(t,"readonly"===n?"readonly":"readwrite",Qa,e=>(s=new ho(e,this.Be?this.Be.next():Pr.I),"readwrite-primary"===n?this.rn(s).next(e=>!!e||this.on(s)).next(e=>{if(!e)throw br(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.We(!1)),new Ar(Sr.FAILED_PRECONDITION,Ya);return r(s)}).next(e=>this.cn(s).next(()=>e)):this.En(s).next(()=>r(s)))).then(e=>(s.raiseOnCommittedEvent(),e))}En(e){return ch(e).get(Oa.key).next(e=>{if(null!==e&&this.fn(e.leaseTimestampMs,5e3)&&!this._n(e.ownerId)&&!this.un(e)&&!(this.Le||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Ar(Sr.FAILED_PRECONDITION,hh)})}cn(e){var t=new Oa(this.clientId,this.allowTabSynchronization,Date.now());return ch(e).put(Oa.key,t)}static bt(){return eo.bt()}an(e){const t=ch(e);return t.get(Oa.key).next(e=>this.un(e)?(wr("IndexedDbPersistence","Releasing primary lease."),t.delete(Oa.key)):Xa.resolve())}fn(e,t){var n=Date.now();return!(e<n-t||n<e&&(br(`Detected an update time that is in the future: ${e} > ${n}`),1))}tn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ke=()=>{this.Oe.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Ze()))},this.document.addEventListener("visibilitychange",this.Ke),this.inForeground="visible"===this.document.visibilityState)}gn(){this.Ke&&(this.document.removeEventListener("visibilitychange",this.Ke),this.Ke=null)}en(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.qe=()=>{this.mn(),s()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.qe))}yn(){this.qe&&(this.window.removeEventListener("pagehide",this.qe),this.qe=null)}_n(e){var t;try{var n=null!==(null===(t=this.Xe)||void 0===t?void 0:t.getItem(this.wn(e)));return wr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return br("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}mn(){if(this.Xe)try{this.Xe.setItem(this.wn(this.clientId),String(Date.now()))}catch(e){br("Failed to set zombie client id.",e)}}pn(){if(this.Xe)try{this.Xe.removeItem(this.wn(this.clientId))}catch(e){}}wn(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function ch(e){return uo(e,Oa.store)}function lh(e){return uo(e,Ha.store)}function dh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class fh{constructor(e,t){this.progress=e,this.In=t}}class gh{constructor(e,t,n){this.Je=e,this.An=t,this.Jt=n}Rn(t,n){return this.An.getAllMutationBatchesAffectingDocumentKey(t,n).next(e=>this.Pn(t,n,e))}Pn(e,t,n){return this.Je.getEntry(e,t).next(e=>{for(const t of n)t.applyToLocalView(e);return e})}bn(e,n){e.forEach((e,t)=>{for(const e of n)e.applyToLocalView(t)})}vn(t,e){return this.Je.getEntries(t,e).next(e=>this.Vn(t,e).next(()=>e))}Vn(e,t){return this.An.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>this.bn(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,os.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.Sn(e,t.path):Qs(t)?this.Dn(e,t,n):this.Cn(e,t,n);var r}Sn(e,t){return this.Rn(e,new os(t)).next(e=>{let t=ji;return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}Dn(r,s,i){const a=s.collectionGroup;let o=ji;return this.Jt.getCollectionParents(r,a).next(e=>Xa.forEach(e,e=>{var t,n=(t=s,e=e.child(a),new js(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.Cn(r,n,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}Cn(t,n,e){let s,i;return this.Je.getDocumentsMatchingQuery(t,n,e).next(e=>(s=e,this.An.getAllMutationBatchesAffectingQuery(t,n))).next(e=>(i=e,this.Nn(t,i,s).next(t=>{s=t;for(const t of i)for(const r of t.mutations){var n=r.key;let e=s.get(n);null==e&&(e=Es.newInvalidDocument(n),s=s.insert(n,e)),Ii(r,e,t.localWriteTime),e.isFoundDocument()||(s=s.remove(n))}}))).next(()=>(s.forEach((e,t)=>{ni(n,t)||(s=s.remove(e))}),s))}Nn(e,t,n){let r=Gi();for(const e of t)for(const t of e.mutations)t instanceof Di&&null===n.get(t.key)&&(r=r.add(t.key));let s=n;return this.Je.getEntries(e,r).next(e=>(e.forEach((e,t)=>{t.isFoundDocument()&&(s=s.insert(e,t))}),s))}}class mh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.kn=n,this.xn=r}static $n(e,t){let n=Gi(),r=Gi();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new mh(e,t.fromCache,n,r)}}class ph{Fn(e){this.On=e}getDocumentsMatchingQuery(t,r,s,i){return 0===(e=r).filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())||s.isEqual(jr.min())?this.Mn(t,r):this.On.vn(t,i).next(e=>{const n=this.Ln(r,e);return(Gs(r)||Hs(r))&&this.Bn(r.limitType,n,i,s)?this.Mn(t,r):(vr()<=l.DEBUG&&wr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),ti(r)),this.On.getDocumentsMatchingQuery(t,r,s).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t)))});var e}Ln(n,e){let r=new Ui(ri(n));return e.forEach((e,t)=>{ni(n,t)&&(r=r.add(t))}),r}Bn(e,t,n,r){if(n.size!==t.size)return!0;const s="F"===e?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Mn(e,t){return vr()<=l.DEBUG&&wr("QueryEngine","Using full collection scan to execute query:",ti(t)),this.On.getDocumentsMatchingQuery(e,t,jr.min())}}class yh{constructor(e,t,n,r){this.persistence=e,this.Un=t,this.k=r,this.qn=new Pi(Vr),this.Kn=new Zo(e=>Ss(e),As),this.jn=jr.min(),this.An=e.getMutationQueue(n),this.Qn=e.getRemoteDocumentCache(),this.He=e.getTargetCache(),this.Wn=new gh(this.Qn,this.An,this.persistence.getIndexManager()),this.Ye=e.getBundleCache(),this.Un.Fn(this.Wn)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.qn))}}function vh(e,t,n,r){return new yh(e,t,n,r)}async function wh(e,t){const n=e;let r=n.An,a=n.Wn;var s=await n.persistence.runTransaction("Handle user change","readonly",s=>{let i;return n.An.getAllMutationBatches(s).next(e=>(i=e,r=n.persistence.getMutationQueue(t),a=new gh(n.Qn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=Gi();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.vn(s,r).next(e=>({Gn:e,removedBatchIds:t,addedBatchIds:n}))})});return n.An=r,n.Wn=a,n.Un.Fn(n.Wn),s}function bh(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.He.getLastRemoteSnapshotVersion(e))}function Th(e,n){const c=e,l=n.snapshotVersion;let d=c.qn;return c.persistence.runTransaction("Apply remote event","readwrite-primary",h=>{const e=c.Qn.newChangeBuffer({trackRemovals:!0});d=c.qn;const u=[];n.targetChanges.forEach((e,t)=>{const n=d.get(t);if(n){u.push(c.He.removeMatchingKeys(h,e.removedDocuments,t).next(()=>c.He.addMatchingKeys(h,e.addedDocuments,t)));const o=e.resumeToken;var r,s,i,a;0<o.approximateByteSize()&&(r=n.withResumeToken(o,l).withSequenceNumber(h.currentSequenceNumber),d=d.insert(t,r),s=n,a=e,_r(0<(i=r).resumeToken.approximateByteSize()),0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(c.He.updateTargetData(h,r)))}});let t=Bi;if(n.documentUpdates.forEach((e,t)=>{n.resolvedLimboDocuments.has(e)&&u.push(c.persistence.referenceDelegate.updateLimboDocument(h,e))}),u.push(Eh(h,e,n.documentUpdates,l,void 0).next(e=>{t=e})),!l.isEqual(jr.min())){const n=c.He.getLastRemoteSnapshotVersion(h).next(e=>c.He.setTargetsMetadata(h,h.currentSequenceNumber,l));u.push(n)}return Xa.waitFor(u).next(()=>e.apply(h)).next(()=>c.Wn.Vn(h,t)).next(()=>t)}).then(e=>(c.qn=d,e))}function Eh(e,a,t,o,h){let n=Gi();return t.forEach(e=>n=n.add(e)),a.getEntries(e,n).next(s=>{let i=Bi;return t.forEach((e,t)=>{const n=s.get(e),r=(null==h?void 0:h.get(e))||o;t.isNoDocument()&&t.version.isEqual(jr.min())?(a.removeEntry(e,r),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(a.addEntry(t,r),i=i.insert(e,t)):wr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),i})}function Ih(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.He.getTargetData(t,r).next(e=>e?(n=e,Xa.resolve(n)):s.He.allocateTargetId(t).next(e=>(n=new fo(r,e,0,t.currentSequenceNumber),s.He.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.qn.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.qn=s.qn.insert(e.targetId,e),s.Kn.set(r,e.targetId)),e})}async function _h(e,t,n){const r=e,s=r.qn.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!ro(e))throw e;wr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.qn=r.qn.remove(t),r.Kn.delete(s.target)}function Sh(e,n,r){const s=e;let i=jr.min(),a=Gi();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.Kn.get(n);return void 0!==s?Xa.resolve(r.qn.get(s)):r.He.getTargetData(t,n)}(s,t,Js(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.He.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.Un.getDocumentsMatchingQuery(t,n,r?i:jr.min(),r?a:Gi())).next(e=>({documents:e,zn:a})))}function Ah(e,t){const n=e,r=n.He,s=n.qn.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.Et(e,t).next(e=>e?e.target:null))}function Dh(e){const n=e;return n.persistence.runTransaction("Get new document changes","readonly",e=>function(e,t,n){const r=e;let s=Bi,i=yo(n);const a=sh(t),o=IDBKeyRange.lowerBound(i,!0);return a.jt({index:qa.readTimeIndex,range:o},(e,t)=>{var n=mo(r.k,t);s=s.insert(n.key,n),i=t.readTime}).next(()=>({In:s,readTime:vo(i)}))}(n.Qn,e,n.jn)).then(({In:e,readTime:t})=>(n.jn=t,e))}class Ch{constructor(e){this.k=e,this.Xn=new Map,this.Zn=new Map}getBundleMetadata(e,t){return Xa.resolve(this.Xn.get(t))}saveBundleMetadata(e,t){return this.Xn.set(t.id,{id:t.id,version:t.version,createTime:oa(t.createTime)}),Xa.resolve()}getNamedQuery(e,t){return Xa.resolve(this.Zn.get(t))}saveNamedQuery(e,t){return this.Zn.set(t.name,{name:(t=t).name,query:_o(t.bundledQuery),readTime:oa(t.readTime)}),Xa.resolve()}}class kh{constructor(){this.ts=new Ui(Nh.es),this.ns=new Ui(Nh.ss)}isEmpty(){return this.ts.isEmpty()}addReference(e,t){var n=new Nh(e,t);this.ts=this.ts.add(n),this.ns=this.ns.add(n)}rs(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.os(new Nh(e,t))}cs(e,t){e.forEach(e=>this.removeReference(e,t))}us(e){const t=new os(new Wr([])),n=new Nh(t,e),r=new Nh(t,e+1),s=[];return this.ns.forEachInRange([n,r],e=>{this.os(e),s.push(e.key)}),s}hs(){this.ts.forEach(e=>this.os(e))}os(e){this.ts=this.ts.delete(e),this.ns=this.ns.delete(e)}ls(e){var t=new os(new Wr([])),n=new Nh(t,e),t=new Nh(t,e+1);let r=Gi();return this.ns.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Nh(e,0),t=this.ts.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Nh{constructor(e,t){this.key=e,this.fs=t}static es(e,t){return os.comparator(e.key,t.key)||Vr(e.fs,t.fs)}static ss(e,t){return Vr(e.fs,t.fs)||os.comparator(e.key,t.key)}}class xh{constructor(e,t){this.Jt=e,this.referenceDelegate=t,this.An=[],this.ds=1,this.ws=new Ui(Nh.es)}checkEmpty(e){return Xa.resolve(0===this.An.length)}addMutationBatch(e,t,n,r){var s=this.ds;this.ds++,0<this.An.length&&this.An[this.An.length-1];var i=new co(s,t,n,r);this.An.push(i);for(const t of r)this.ws=this.ws.add(new Nh(t.key,s)),this.Jt.addToCollectionParentIndex(e,t.key.path.popLast());return Xa.resolve(i)}lookupMutationBatch(e,t){return Xa.resolve(this._s(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.gs(t+1),n=n<0?0:n;return Xa.resolve(this.An.length>n?this.An[n]:null)}getHighestUnacknowledgedBatchId(){return Xa.resolve(0===this.An.length?-1:this.ds-1)}getAllMutationBatches(e){return Xa.resolve(this.An.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Nh(t,0),r=new Nh(t,Number.POSITIVE_INFINITY),s=[];return this.ws.forEachInRange([n,r],e=>{var t=this._s(e.fs);s.push(t)}),Xa.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new Ui(Vr);return t.forEach(e=>{var t=new Nh(e,0),n=new Nh(e,Number.POSITIVE_INFINITY);this.ws.forEachInRange([t,n],e=>{r=r.add(e.fs)})}),Xa.resolve(this.ys(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;os.isDocumentKey(s)||(s=s.child(""));var i=new Nh(new os(s),0);let a=new Ui(Vr);return this.ws.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.fs)),!0)},i),Xa.resolve(this.ys(a))}ys(e){const n=[];return e.forEach(e=>{var t=this._s(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){_r(0===this.ps(r.batchId,"removed")),this.An.shift();let s=this.ws;return Xa.forEach(r.mutations,e=>{var t=new Nh(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.ws=s})}ee(e){}containsKey(e,t){var n=new Nh(t,0),n=this.ws.firstAfterOrEqual(n);return Xa.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.An.length,Xa.resolve()}ps(e,t){return this.gs(e)}gs(e){return 0===this.An.length?0:e-this.An[0].batchId}_s(e){var t=this.gs(e);return t<0||t>=this.An.length?null:this.An[t]}}class Rh{constructor(e,t){this.Jt=e,this.Ts=t,this.docs=new Pi(os.comparator),this.size=0}addEntry(e,t,n){const r=t.key,s=this.docs.get(r),i=s?s.size:0,a=this.Ts(t);return this.docs=this.docs.insert(r,{document:t.clone(),size:a,readTime:n}),this.size+=a-i,this.Jt.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return Xa.resolve(n?n.document.clone():Es.newInvalidDocument(t))}getEntries(e,t){let n=Bi;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.clone():Es.newInvalidDocument(e))}),Xa.resolve(n)}getDocumentsMatchingQuery(e,t,n){let r=Bi;const s=new os(t.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s,readTime:a}}=i.getNext();if(!t.path.isPrefixOf(e.path))break;a.compareTo(n)<=0||ni(t,s)&&(r=r.insert(s.key,s.clone()))}return Xa.resolve(r)}Es(e,t){return Xa.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Lh(this)}getSize(e){return Xa.resolve(this.size)}}class Lh extends eh{constructor(e){super(),this.De=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.document.isValidDocument()?r.push(this.De.addEntry(n,t.document,this.getReadTime(e))):this.De.removeEntry(e)}),Xa.waitFor(r)}getFromCache(e,t){return this.De.getEntry(e,t)}getAllFromCache(e,t){return this.De.getEntries(e,t)}}class Oh{constructor(e){this.persistence=e,this.Is=new Zo(e=>Ss(e),As),this.lastRemoteSnapshotVersion=jr.min(),this.highestTargetId=0,this.As=0,this.Rs=new kh,this.targetCount=0,this.Ps=Bo.ie()}forEachTarget(e,n){return this.Is.forEach((e,t)=>n(t)),Xa.resolve()}getLastRemoteSnapshotVersion(e){return Xa.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return Xa.resolve(this.As)}allocateTargetId(e){return this.highestTargetId=this.Ps.next(),Xa.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.As&&(this.As=t),Xa.resolve()}ce(e){this.Is.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Ps=new Bo(t),this.highestTargetId=t),e.sequenceNumber>this.As&&(this.As=e.sequenceNumber)}addTargetData(e,t){return this.ce(t),this.targetCount+=1,Xa.resolve()}updateTargetData(e,t){return this.ce(t),Xa.resolve()}removeTargetData(e,t){return this.Is.delete(t.target),this.Rs.us(t.targetId),--this.targetCount,Xa.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Is.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Is.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),Xa.waitFor(a).next(()=>i)}getTargetCount(e){return Xa.resolve(this.targetCount)}getTargetData(e,t){var n=this.Is.get(t)||null;return Xa.resolve(n)}addMatchingKeys(e,t,n){return this.Rs.rs(t,n),Xa.resolve()}removeMatchingKeys(t,e,n){this.Rs.cs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),Xa.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Rs.us(t),Xa.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Rs.ls(t);return Xa.resolve(n)}containsKey(e,t){return Xa.resolve(this.Rs.containsKey(t))}}class Mh{constructor(e,t){var n;this.bs={},this.Be=new Pr(0),this.Ue=!1,this.Ue=!0,this.referenceDelegate=e(this),this.He=new Oh(this),this.Jt=new Co,this.Je=(n=this.Jt,e=e=>this.referenceDelegate.vs(e),new Rh(n,e)),this.k=new go(t),this.Ye=new Ch(this.k)}start(){return Promise.resolve()}shutdown(){return this.Ue=!1,Promise.resolve()}get started(){return this.Ue}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Jt}getMutationQueue(e){let t=this.bs[e.toKey()];return t||(t=new xh(this.Jt,this.referenceDelegate),this.bs[e.toKey()]=t),t}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getBundleCache(){return this.Ye}runTransaction(e,t,n){wr("MemoryPersistence","Starting transaction:",e);const r=new Ph(this.Be.next());return this.referenceDelegate.Vs(),n(r).next(e=>this.referenceDelegate.Ss(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ds(t,n){return Xa.or(Object.values(this.bs).map(e=>()=>e.containsKey(t,n)))}}class Ph extends Ja{constructor(e){super(),this.currentSequenceNumber=e}}class Fh{constructor(e){this.persistence=e,this.Cs=new kh,this.Ns=null}static ks(e){return new Fh(e)}get xs(){if(this.Ns)return this.Ns;throw Ir()}addReference(e,t,n){return this.Cs.addReference(n,t),this.xs.delete(n.toString()),Xa.resolve()}removeReference(e,t,n){return this.Cs.removeReference(n,t),this.xs.add(n.toString()),Xa.resolve()}markPotentiallyOrphaned(e,t){return this.xs.add(t.toString()),Xa.resolve()}removeTarget(e,t){this.Cs.us(t.targetId).forEach(e=>this.xs.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.xs.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Vs(){this.Ns=new Set}Ss(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Xa.forEach(this.xs,e=>{const t=os.fromPath(e);return this.$s(n,t).next(e=>{e||r.removeEntry(t)})}).next(()=>(this.Ns=null,r.apply(n)))}updateLimboDocument(e,t){return this.$s(e,t).next(e=>{e?this.xs.delete(t.toString()):this.xs.add(t.toString())})}vs(e){return 0}$s(e,t){return Xa.or([()=>Xa.resolve(this.Cs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ds(e,t)])}}function Vh(e,t){return`firestore_clients_${e}_${t}`}function Uh(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function qh(e,t){return`firestore_targets_${e}_${t}`}class Bh{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Fs(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Ar(r.error.code,r.error.message))),i?new Bh(e,t,r.state,s):(br("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Os(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class jh{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Fs(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Ar(n.error.code,n.error.message))),s?new jh(e,n.state,r):(br("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Os(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Kh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Fs(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Hi;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=as(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Kh(e,s):(br("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class $h{constructor(e,t){this.clientId=e,this.onlineState=t}static Fs(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new $h(t.clientId,t.onlineState):(br("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Gh{constructor(){this.activeTargetIds=Hi}Ms(e){this.activeTargetIds=this.activeTargetIds.add(e)}Ls(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Os(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Hh{constructor(e,t,n,r,s){this.window=e,this.Oe=t,this.persistenceKey=n,this.Bs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Us=this.qs.bind(this),this.Ks=new Pi(Vr),this.started=!1,this.js=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Qs=Vh(this.persistenceKey,this.Bs),this.Ws=`firestore_sequence_number_${this.persistenceKey}`,this.Ks=this.Ks.insert(this.Bs,new Gh),this.Gs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.zs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Hs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Js=`firestore_online_state_${this.persistenceKey}`,this.Ys=`firestore_bundle_loaded_${this.persistenceKey}`,this.window.addEventListener("storage",this.Us)}static bt(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Tn();for(const n of e)if(n!==this.Bs){const e=this.getItem(Vh(this.persistenceKey,n));var t;!e||(t=Kh.Fs(n,e))&&(this.Ks=this.Ks.insert(t.clientId,t))}this.Xs();const n=this.storage.getItem(this.Js);if(n){const e=this.Zs(n);e&&this.ti(e)}for(const e of this.js)this.qs(e);this.js=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ws,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ei(this.Ks)}isActiveQueryTarget(n){let r=!1;return this.Ks.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.ni(e,"pending")}updateMutationState(e,t,n){this.ni(e,t,n),this.si(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(qh(this.persistenceKey,e)))||(n=jh.Fs(e,n))&&(t=n.state)),this.ii.Ms(e),this.Xs(),t}removeLocalQueryTarget(e){this.ii.Ls(e),this.Xs()}isLocalQueryTarget(e){return this.ii.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(qh(this.persistenceKey,e))}updateQueryState(e,t,n){this.ri(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.si(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.oi(e)}notifyBundleLoaded(){this.ai()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Us),this.removeItem(this.Qs),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return wr("SharedClientState","READ",e,t),t}setItem(e,t){wr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){wr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}qs(e){const r=e;r.storageArea===this.storage&&(wr("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.Qs?this.Oe.enqueueRetryable(async()=>{if(this.started){if(null!==r.key)if(this.Gs.test(r.key)){if(null==r.newValue){var e=this.ci(r.key);return this.ui(e,null)}e=this.hi(r.key,r.newValue);if(e)return this.ui(e.clientId,e)}else if(this.zs.test(r.key)){if(null!==r.newValue){var t=this.li(r.key,r.newValue);if(t)return this.fi(t)}}else if(this.Hs.test(r.key)){if(null!==r.newValue){t=this.di(r.key,r.newValue);if(t)return this.wi(t)}}else if(r.key===this.Js){if(null!==r.newValue){var n=this.Zs(r.newValue);if(n)return this.ti(n)}}else if(r.key===this.Ws){n=function(e){let t=Pr.I;if(null!=e)try{var n=JSON.parse(e);_r("number"==typeof n),t=n}catch(e){br("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(r.newValue);n!==Pr.I&&this.sequenceNumberHandler(n)}else if(r.key===this.Ys)return this.syncEngine._i()}else this.js.push(r)}):br("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get ii(){return this.Ks.get(this.Bs)}Xs(){this.setItem(this.Qs,this.ii.Os())}ni(e,t,n){const r=new Bh(this.currentUser,e,t,n),s=Uh(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Os())}si(e){var t=Uh(this.persistenceKey,this.currentUser,e);this.removeItem(t)}oi(e){var t={clientId:this.Bs,onlineState:e};this.storage.setItem(this.Js,JSON.stringify(t))}ri(e,t,n){const r=qh(this.persistenceKey,e),s=new jh(e,t,n);this.setItem(r,s.Os())}ai(){this.setItem(this.Ys,"value-not-used")}ci(e){var t=this.Gs.exec(e);return t?t[1]:null}hi(e,t){var n=this.ci(e);return Kh.Fs(n,t)}li(e,t){var n=this.zs.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Bh.Fs(new mr(n),r,t)}di(e,t){var n=this.Hs.exec(e),n=Number(n[1]);return jh.Fs(n,t)}Zs(e){return $h.Fs(e)}async fi(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.mi(e.batchId,e.state,e.error);wr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}wi(e){return this.syncEngine.gi(e.targetId,e.state,e.error)}ui(e,t){const n=t?this.Ks.insert(e,t):this.Ks.remove(e),r=this.ei(this.Ks),s=this.ei(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.yi(i,a).then(()=>{this.Ks=n})}ti(e){this.Ks.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ei(e){let n=Hi;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Wh{constructor(){this.pi=new Gh,this.Ti={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.pi.Ms(e),this.Ti[e]||"not-current"}updateQueryState(e,t,n){this.Ti[e]=t}removeLocalQueryTarget(e){this.pi.Ls(e)}isLocalQueryTarget(e){return this.pi.activeTargetIds.has(e)}clearQueryState(e){delete this.Ti[e]}getAllActiveQueryTargets(){return this.pi.activeTargetIds}isActiveQueryTarget(e){return this.pi.activeTargetIds.has(e)}start(){return this.pi=new Gh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(){}}class zh{Ei(e){}shutdown(){}}class Qh{constructor(){this.Ii=()=>this.Ai(),this.Ri=()=>this.Pi(),this.bi=[],this.vi()}Ei(e){this.bi.push(e)}shutdown(){window.removeEventListener("online",this.Ii),window.removeEventListener("offline",this.Ri)}vi(){window.addEventListener("online",this.Ii),window.addEventListener("offline",this.Ri)}Ai(){wr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.bi)e(0)}Pi(){wr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.bi)e(1)}static bt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Yh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Jh{constructor(e){this.Vi=e.Vi,this.Si=e.Si}Di(e){this.Ci=e}Ni(e){this.ki=e}onMessage(e){this.xi=e}close(){this.Si()}send(e){this.Vi(e)}$i(){this.Ci()}Fi(e){this.ki(e)}Oi(e){this.xi(e)}}class Xh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.Mi=t+"://"+e.host,this.Li="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Bi(t,e,n,r,s){const i=this.Ui(t,e);wr("RestConnection","Sending: ",i,n);var a={};return this.qi(a,r,s),this.Ki(t,i,a,n).then(e=>(wr("RestConnection","Received: ",e),e),e=>{throw Tr("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e})}ji(e,t,n,r,s){return this.Bi(e,t,n,r,s)}qi(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+pr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}Ui(e,t){var n=Yh[e];return`${this.Mi}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}Ki(o,t,n,r){return new Promise((s,i)=>{const a=new fr;a.listenOnce(or.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case ar.NO_ERROR:var e=a.getResponseJson();wr("Connection","XHR received:",JSON.stringify(e)),s(e);break;case ar.TIMEOUT:wr("Connection",'RPC "'+o+'" timed out'),i(new Ar(Sr.DEADLINE_EXCEEDED,"Request time out"));break;case ar.HTTP_ERROR:var t,n=a.getStatus();if(wr("Connection",'RPC "'+o+'" failed with status:',n,"response text:",a.getResponseText()),0<n){const o=a.getResponseJson().error;o&&o.status&&o.message?(r=o.status.toLowerCase().replace(/_/g,"-"),t=0<=Object.values(Sr).indexOf(r)?r:Sr.UNKNOWN,i(new Ar(t,o.message))):i(new Ar(Sr.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new Ar(Sr.UNAVAILABLE,"Connection failed."));break;default:Ir()}}finally{wr("Connection",'RPC "'+o+'" completed.')}var r});var e=JSON.stringify(r);a.send(t,"POST",e,n,15)})}Qi(e,t,n){const r=[this.Mi,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new Zn,i=ir(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new lr({})),this.qi(a.initMessageHeaders,t,n),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(f())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=f().indexOf("Electron/")||function(){const e=f();return 0<=e.indexOf("MSIE ")||0<=e.indexOf("Trident/")}()||0<=f().indexOf("MSAppHost/")||"object"==typeof(o="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==o.id||(a.httpHeadersOverwriteParam="$httpHeaders");var o=r.join("");wr("Connection","Creating WebChannel: "+o,a);const h=s.createWebChannel(o,a);let u=!1,c=!1;const l=new Jh({Vi:e=>{c?wr("Connection","Not sending because WebChannel is closed:",e):(u||(wr("Connection","Opening WebChannel transport."),h.open(),u=!0),wr("Connection","WebChannel sending:",e),h.send(e))},Si:()=>h.close()}),d=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return d(h,dr.EventType.OPEN,()=>{c||wr("Connection","WebChannel transport opened.")}),d(h,dr.EventType.CLOSE,()=>{c||(c=!0,wr("Connection","WebChannel transport closed"),l.Fi())}),d(h,dr.EventType.ERROR,e=>{c||(c=!0,Tr("Connection","WebChannel transport errored:",e),l.Fi(new Ar(Sr.UNAVAILABLE,"The operation could not be completed")))}),d(h,dr.EventType.MESSAGE,n=>{if(!c){var e=n.data[0];_r(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){wr("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){var t=sr[e];if(void 0!==t)return Mi(t)}(n),t=r.message;void 0===e&&(e=Sr.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,l.Fi(new Ar(e,t)),h.close()}else wr("Connection","WebChannel received:",e),l.Oi(e)}}),d(i,hr.STAT_EVENT,e=>{e.stat===ur?wr("Connection","Detected buffering proxy"):e.stat===cr&&wr("Connection","Detected no buffering proxy")}),setTimeout(()=>{l.$i()},0),l}}function Zh(){return"undefined"!=typeof window?window:null}function eu(){return"undefined"!=typeof document?document:null}function tu(e){return new sa(e,!0)}class nu{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Oe=e,this.timerId=t,this.Wi=n,this.Gi=r,this.zi=s,this.Hi=0,this.Ji=null,this.Yi=Date.now(),this.reset()}reset(){this.Hi=0}Xi(){this.Hi=this.zi}Zi(e){this.cancel();var t=Math.floor(this.Hi+this.tr()),n=Math.max(0,Date.now()-this.Yi),r=Math.max(0,t-n);0<r&&wr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Hi} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Ji=this.Oe.enqueueAfterDelay(this.timerId,r,()=>(this.Yi=Date.now(),e())),this.Hi*=this.Gi,this.Hi<this.Wi&&(this.Hi=this.Wi),this.Hi>this.zi&&(this.Hi=this.zi)}er(){null!==this.Ji&&(this.Ji.skipDelay(),this.Ji=null)}cancel(){null!==this.Ji&&(this.Ji.cancel(),this.Ji=null)}tr(){return(Math.random()-.5)*this.Hi}}class ru{constructor(e,t,n,r,s,i,a,o){this.Oe=e,this.nr=n,this.sr=r,this.ir=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.rr=0,this.ar=null,this.cr=null,this.stream=null,this.ur=new nu(e,t)}hr(){return 1===this.state||5===this.state||this.lr()}lr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.dr()}async stop(){this.hr()&&await this.close(0)}wr(){this.state=0,this.ur.reset()}_r(){this.lr()&&null===this.ar&&(this.ar=this.Oe.enqueueAfterDelay(this.nr,6e4,()=>this.mr()))}gr(e){this.yr(),this.stream.send(e)}async mr(){if(this.lr())return this.close(0)}yr(){this.ar&&(this.ar.cancel(),this.ar=null)}pr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(e,t){this.yr(),this.pr(),this.ur.cancel(),this.rr++,4!==e?this.ur.reset():t&&t.code===Sr.RESOURCE_EXHAUSTED?(br(t.toString()),br("Using maximum backoff delay to prevent overloading the backend."),this.ur.Xi()):t&&t.code===Sr.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Tr(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ni(t)}Tr(){}auth(){this.state=1;const e=this.Er(this.rr),n=this.rr;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.rr===n&&this.Ir(e,t)},t=>{e(()=>{var e=new Ar(Sr.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Ar(e)})})}Ir(e,t){const n=this.Er(this.rr);this.stream=this.Rr(e,t),this.stream.Di(()=>{n(()=>(this.state=2,this.cr=this.Oe.enqueueAfterDelay(this.sr,1e4,()=>(this.lr()&&(this.state=3),Promise.resolve())),this.listener.Di()))}),this.stream.Ni(e=>{n(()=>this.Ar(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}dr(){this.state=5,this.ur.Zi(async()=>{this.state=0,this.start()})}Ar(e){return wr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Er(t){return e=>{this.Oe.enqueueAndForget(()=>this.rr===t?e():(wr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class su extends ru{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.k=s}Rr(e,t){return this.ir.Qi("Listen",e,t)}onMessage(e){this.ur.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Ir(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.C?(_r(void 0===f||"string"==typeof f),Jr.fromBase64String(f||"")):(_r(void 0===f||f instanceof Uint8Array),Jr.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Sr.UNKNOWN:Mi(f.code),new Ar(o,f.message||""));n=new Ji(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;var h=t.documentChange;h.document,h.document.name,h.document.updateTime;var o=la(e,h.document.name),u=oa(h.document.updateTime),c=new Ts({mapValue:{fields:h.document.fields}}),u=Es.newFoundDocument(o,u,c),c=h.targetIds||[],h=h.removedTargetIds||[];n=new Qi(c,h,u.key,u)}else if("documentDelete"in t){t.documentDelete;c=t.documentDelete;c.document;h=la(e,c.document),u=c.readTime?oa(c.readTime):jr.min(),u=Es.newNoDocument(h,u),c=c.removedTargetIds||[];n=new Qi([],c,u.key,u)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=la(e,l.document),l=l.removedTargetIds||[];n=new Qi([],l,d,null)}else{if(!("filter"in t))return Ir();{t.filter;const e=t.filter;e.targetId;l=e.count||0,d=new Li(l),l=e.targetId;n=new Yi(l,d)}}var o,f;return n}(this.k,e),n=function(e){if(!("targetChange"in e))return jr.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?oa(t.readTime):jr.min()}(e);return this.listener.Pr(t,n)}br(e){const t={};t.database=ga(this.k),t.addTarget=function(e,t){let n;var r=t.target;return n=Ds(r)?{documents:ba(e,r)}:{query:Ta(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=aa(e,t.resumeToken):0<t.snapshotVersion.compareTo(jr.min())&&(n.readTime=ia(e,t.snapshotVersion.toTimestamp())),n}(this.k,e);var n,r,r=(this.k,n=e,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ir()}}())?null:{"goog-listen-tags":r});r&&(t.labels=r),this.gr(t)}vr(e){const t={};t.database=ga(this.k),t.removeTarget=e,this.gr(t)}}class iu extends ru{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.k=s,this.Vr=!1}get Sr(){return this.Vr}start(){this.Vr=!1,this.lastStreamToken=void 0,super.start()}Tr(){this.Vr&&this.Dr([])}Rr(e,t){return this.ir.Qi("Write",e,t)}onMessage(e){if(_r(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Vr){this.ur.reset();var t=(r=e.writeResults,s=e.commitTime,r&&0<r.length?(_r(void 0!==s),r.map(e=>function(e,t){let n=e.updateTime?oa(e.updateTime):oa(t);return n.isEqual(jr.min())&&(n=oa(t)),new vi(n,e.transformResults||[])}(e,s))):[]),n=oa(e.commitTime);return this.listener.Cr(n,t)}var r,s;return _r(!e.writeResults||0===e.writeResults.length),this.Vr=!0,this.listener.Nr()}kr(){const e={};e.database=ga(this.k),this.gr(e)}Dr(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>va(this.k,e))};this.gr(t)}}class au extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.ir=n,this.k=r,this.$r=!1}Fr(){if(this.$r)throw new Ar(Sr.FAILED_PRECONDITION,"The client has already been terminated.")}Bi(n,r,s){return this.Fr(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.ir.Bi(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Sr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Ar(Sr.UNKNOWN,e.toString())})}ji(n,r,s){return this.Fr(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.ir.ji(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Sr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Ar(Sr.UNKNOWN,e.toString())})}terminate(){this.$r=!0}}class ou{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.Or=0,this.Mr=null,this.Lr=!0}Br(){0===this.Or&&(this.Ur("Unknown"),this.Mr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.Mr=null,this.qr("Backend didn't respond within 10 seconds."),this.Ur("Offline"),Promise.resolve())))}Kr(e){"Online"===this.state?this.Ur("Unknown"):(this.Or++,1<=this.Or&&(this.jr(),this.qr(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.Ur("Offline")))}set(e){this.jr(),this.Or=0,"Online"===e&&(this.Lr=!1),this.Ur(e)}Ur(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}qr(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Lr?(br(t),this.Lr=!1):wr("OnlineStateTracker",t)}jr(){null!==this.Mr&&(this.Mr.cancel(),this.Mr=null)}}class hu{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Qr=[],this.Wr=new Map,this.Gr=new Set,this.zr=[],this.Hr=s,this.Hr.Ei(e=>{n.enqueueAndForget(async()=>{yu(this)&&(wr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.Gr.add(4),await cu(t),t.Jr.set("Unknown"),t.Gr.delete(4),await uu(t)}(this))})}),this.Jr=new ou(n,r)}}async function uu(e){if(yu(e))for(const t of e.zr)await t(!0)}async function cu(e){for(const t of e.zr)await t(!1)}function lu(e,t){const n=e;n.Wr.has(t.targetId)||(n.Wr.set(t.targetId,t),pu(n)?mu(n):Su(n).lr()&&fu(n,t))}function du(e,t){const n=e,r=Su(n);n.Wr.delete(t),r.lr()&&gu(n,t),0===n.Wr.size&&(r.lr()?r._r():yu(n)&&n.Jr.set("Unknown"))}function fu(e,t){e.Yr.X(t.targetId),Su(e).br(t)}function gu(e,t){e.Yr.X(t),Su(e).vr(t)}function mu(t){t.Yr=new Zi({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Et:e=>t.Wr.get(e)||null}),Su(t).start(),t.Jr.Br()}function pu(e){return yu(e)&&!Su(e).hr()&&0<e.Wr.size}function yu(e){return 0===e.Gr.size}function vu(e){e.Yr=void 0}async function wu(e,t,n){if(!ro(t))throw t;e.Gr.add(1),await cu(e),e.Jr.set("Offline"),n=n||(()=>bh(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{wr("RemoteStore","Retrying IndexedDB access"),await n(),e.Gr.delete(1),await uu(e)})}function bu(t,n){return n().catch(e=>wu(t,e,n))}async function Tu(e){const t=e,n=Au(t);let r=0<t.Qr.length?t.Qr[t.Qr.length-1].batchId:-1;for(;yu(s=t)&&s.Qr.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.An.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.Qr.length&&n._r();break}r=e.batchId,function(e,t){e.Qr.push(t);const n=Au(e);n.lr()&&n.Sr&&n.Dr(t.mutations)}(t,e)}catch(e){await wu(t,e)}var s;Eu(t)&&Iu(t)}function Eu(e){return yu(e)&&!Au(e).hr()&&0<e.Qr.length}function Iu(e){Au(e).start()}async function _u(e,t){const n=e;t?(n.Gr.delete(2),await uu(n)):(n.Gr.add(2),await cu(n),n.Jr.set("Unknown"))}function Su(t){return t.Xr||(t.Xr=function(e,t,n){const r=e;return r.Fr(),new su(t,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(t.datastore,t.asyncQueue,{Di:(async function(n){n.Wr.forEach((e,t)=>{fu(n,e)})}).bind(null,t),Ni:(async function(e,t){vu(e),pu(e)?(e.Jr.Kr(t),mu(e)):e.Jr.set("Unknown")}).bind(null,t),Pr:(async function(e,r,t){if(e.Jr.set("Online"),r instanceof Ji&&2===r.state&&r.cause)try{await async function(e){var t=r.cause;for(const n of r.targetIds)e.Wr.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.Wr.delete(n),e.Yr.removeTarget(n))}(e)}catch(t){wr("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await wu(e,t)}else if(r instanceof Qi?e.Yr.ot(r):r instanceof Yi?e.Yr.dt(r):e.Yr.ut(r),!t.isEqual(jr.min()))try{const r=await bh(e.localStore);0<=t.compareTo(r)&&await function(r,s){const e=r.Yr.gt(s);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=r.Wr.get(t);n&&r.Wr.set(t,n.withResumeToken(e.resumeToken,s))}}),e.targetMismatches.forEach(e=>{const t=r.Wr.get(e);var n;t&&(r.Wr.set(e,t.withResumeToken(Jr.EMPTY_BYTE_STRING,t.snapshotVersion)),gu(r,e),n=new fo(t.target,e,1,t.sequenceNumber),fu(r,n))}),r.remoteSyncer.applyRemoteEvent(e)}(e,t)}catch(r){wr("RemoteStore","Failed to raise snapshot:",r),await wu(e,r)}}).bind(null,t)}),t.zr.push(async e=>{e?(t.Xr.wr(),pu(t)?mu(t):t.Jr.set("Unknown")):(await t.Xr.stop(),vu(t))})),t.Xr}function Au(t){return t.Zr||(t.Zr=function(e,t,n){const r=e;return r.Fr(),new iu(t,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(t.datastore,t.asyncQueue,{Di:(async function(e){Au(e).kr()}).bind(null,t),Ni:(async function(e,t){t&&Au(e).Sr&&await async function(e,t){if(Oi(n=t.code)&&n!==Sr.ABORTED){const n=e.Qr.shift();Au(e).wr(),await bu(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await Tu(e)}var n}(e,t),Eu(e)&&Iu(e)}).bind(null,t),Nr:(async function(e){const t=Au(e);for(const n of e.Qr)t.Dr(n.mutations)}).bind(null,t),Cr:(async function(e,t,n){const r=e.Qr.shift(),s=lo.from(r,t,n);await bu(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Tu(e)}).bind(null,t)}),t.zr.push(async e=>{e?(t.Zr.wr(),await Tu(t)):(await t.Zr.stop(),0<t.Qr.length&&(wr("RemoteStore",`Stopping write stream with ${t.Qr.length} pending writes`),t.Qr=[]))})),t.Zr}class Du{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Dr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new Du(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ar(Sr.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Cu(e,t){if(br("AsyncQueue",`${t}: ${e}`),ro(e))return new Ar(Sr.UNAVAILABLE,`${t}: ${e}`);throw e}class ku{constructor(n){this.comparator=n?(e,t)=>n(e,t)||os.comparator(e.key,t.key):(e,t)=>os.comparator(e.key,t.key),this.keyedMap=ji,this.sortedSet=new Pi(this.comparator)}static emptySet(e){return new ku(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof ku))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new ku;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Nu{constructor(){this.eo=new Pi(os.comparator)}track(e){var t=e.doc.key,n=this.eo.get(t);!n||0!==e.type&&3===n.type?this.eo=this.eo.insert(t,e):3===e.type&&1!==n.type?this.eo=this.eo.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.eo=this.eo.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.eo=this.eo.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.eo=this.eo.remove(t):1===e.type&&2===n.type?this.eo=this.eo.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.eo=this.eo.insert(t,{type:2,doc:e.doc}):Ir()}no(){const n=[];return this.eo.inorderTraversal((e,t)=>{n.push(t)}),n}}class xu{constructor(e,t,n,r,s,i,a,o){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new xu(e,t,ku.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Zs(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Ru{constructor(){this.so=void 0,this.listeners=[]}}class Lu{constructor(){this.queries=new Zo(e=>ei(e),Zs),this.onlineState="Unknown",this.io=new Set}}async function Ou(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Ru),s)try{i.so=await n.onListen(r)}catch(e){const n=Cu(e,`Initialization of query '${ti(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.ro(n.onlineState),!i.so||t.oo(i.so)&&Pu(n)}async function Mu(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Pu(e){e.io.forEach(e=>{e.next()})}class Fu{constructor(e,t,n){this.query=e,this.ao=t,this.co=!1,this.uo=null,this.onlineState="Unknown",this.options=n||{}}oo(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new xu(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.co?this.ho(e)&&(this.ao.next(e),t=!0):this.lo(e,this.onlineState)&&(this.fo(e),t=!0),this.uo=e,t}onError(e){this.ao.error(e)}ro(e){this.onlineState=e;let t=!1;return this.uo&&!this.co&&this.lo(this.uo,e)&&(this.fo(this.uo),t=!0),t}lo(e,t){return!e.fromCache||!(this.options.wo&&"Offline"!==t||e.docs.isEmpty()&&"Offline"!==t)}ho(e){if(0<e.docChanges.length)return!0;var t=this.uo&&this.uo.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}fo(e){e=xu.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.co=!0,this.ao.next(e)}}class Vu{constructor(e,t){this.payload=e,this.byteLength=t}_o(){return"metadata"in this.payload}}class Uu{constructor(e){this.k=e}Hn(e){return la(this.k,e)}Jn(e){return e.metadata.exists?ya(this.k,e.document,!1):Es.newNoDocument(this.Hn(e.metadata.name),this.Yn(e.metadata.readTime))}Yn(e){return oa(e)}}class qu{constructor(e,t,n){this.mo=e,this.localStore=t,this.k=n,this.queries=[],this.documents=[],this.progress=Bu(e)}yo(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;return e.payload.namedQuery?this.queries.push(e.payload.namedQuery):e.payload.documentMetadata?(this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t):e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}po(e){const t=new Map,n=new Uu(this.k);for(const s of e)if(s.metadata.queries){const e=n.Hn(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||Gi()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=Gi(),a=Bi,o=Ki;for(const e of n){const n=t.Hn(e.metadata.name);e.document&&(i=i.add(n)),a=a.insert(n,t.Jn(e)),o=o.insert(n,t.Yn(e.metadata.readTime))}const h=s.Qn.newChangeBuffer({trackRemovals:!0}),u=await Ih(s,(r=r,Js($s(Wr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>Eh(t,h,a,jr.min(),o).next(e=>(h.apply(t),e)).next(e=>s.He.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.He.addMatchingKeys(t,i,u.targetId)).next(()=>s.Wn.Vn(t,e)).next(()=>e)))}(this.localStore,new Uu(this.k),this.documents,this.mo.id),t=this.po(this.documents);for(const e of this.queries)await async function(e,n,r=Gi()){const s=await Ih(e,Js(_o(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=oa(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.Ye.saveNamedQuery(e,n);t=s.withResumeToken(Jr.EMPTY_BYTE_STRING,t);return i.qn=i.qn.insert(t.targetId,t),i.He.updateTargetData(e,t).next(()=>i.He.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.He.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ye.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",new fh(Object.assign({},this.progress),e)}}function Bu(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class ju{constructor(e){this.key=e}}class Ku{constructor(e){this.key=e}}class $u{constructor(e,t){this.query=e,this.To=t,this.Eo=null,this.current=!1,this.Io=Gi(),this.mutatedKeys=Gi(),this.Ao=ri(e),this.Ro=new ku(this.Ao)}get Po(){return this.To}bo(e,t){const o=t?t.vo:new Nu,h=(t||this).Ro;let u=(t||this).mutatedKeys,c=h,l=!1;const d=Gs(this.query)&&h.size===this.query.limit?h.last():null,f=Hs(this.query)&&h.size===this.query.limit?h.first():null;if(e.inorderTraversal((e,t)=>{const n=h.get(e),r=ni(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.Vo(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Ao(r,d)||f&&this.Ao(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(u=r?(c=c.add(r),i?u.add(e):u.delete(e)):(c=c.delete(e),u.delete(e)))}),Gs(this.query)||Hs(this.query))for(;c.size>this.query.limit;){const e=Gs(this.query)?c.last():c.first();c=c.delete(e.key),u=u.delete(e.key),o.track({type:1,doc:e})}return{Ro:c,vo:o,Bn:l,mutatedKeys:u}}Vo(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Ro;this.Ro=e.Ro,this.mutatedKeys=e.mutatedKeys;const s=e.vo.no();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ir()}};return n(e)-n(t)}(e.type,t.type)||this.Ao(e.doc,t.doc)),this.So(n);var i=t?this.Do():[],a=0===this.Io.size&&this.current?1:0,o=a!==this.Eo;return this.Eo=a,0!==s.length||o?{snapshot:new xu(this.query,e.Ro,r,s,e.mutatedKeys,0==a,o,!1),Co:i}:{Co:i}}ro(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ro:this.Ro,vo:new Nu,mutatedKeys:this.mutatedKeys,Bn:!1},!1)):{Co:[]}}No(e){return!this.To.has(e)&&!!this.Ro.has(e)&&!this.Ro.get(e).hasLocalMutations}So(e){e&&(e.addedDocuments.forEach(e=>this.To=this.To.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.To=this.To.delete(e)),this.current=e.current)}Do(){if(!this.current)return[];const t=this.Io;this.Io=Gi(),this.Ro.forEach(e=>{this.No(e.key)&&(this.Io=this.Io.add(e.key))});const n=[];return t.forEach(e=>{this.Io.has(e)||n.push(new Ku(e))}),this.Io.forEach(e=>{t.has(e)||n.push(new ju(e))}),n}ko(e){this.To=e.zn,this.Io=Gi();var t=this.bo(e.documents);return this.applyChanges(t,!0)}xo(){return xu.fromInitialDocuments(this.query,this.Ro,this.mutatedKeys,0===this.Eo)}}class Gu{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Hu{constructor(e){this.key=e,this.$o=!1}}class Wu{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Fo={},this.Oo=new Zo(e=>ei(e),Zs),this.Mo=new Map,this.Lo=new Set,this.Bo=new Pi(os.comparator),this.Uo=new Map,this.qo=new kh,this.Ko={},this.jo=new Map,this.Qo=Bo.re(),this.onlineState="Unknown",this.Wo=void 0}get isPrimaryClient(){return!0===this.Wo}}async function zu(n,e,t,r){n.Go=(e,i,t)=>async function(e,t,n){let r=t.view.bo(i);r.Bn&&(r=await Sh(e.localStore,t.query,!1).then(({documents:e})=>t.view.bo(e,r)));var s=n&&n.targetChanges.get(t.targetId),s=t.view.applyChanges(r,e.isPrimaryClient,s);return rc(e,t.targetId,s.Co),s.snapshot}(n,e,t);const s=await Sh(n.localStore,e,!0),i=new $u(e,s.zn),a=i.bo(s.documents),o=zi.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState),h=i.applyChanges(a,n.isPrimaryClient,o);rc(n,t,h.Co);var u=new Gu(e,t,i);return n.Oo.set(e,u),n.Mo.has(t)?n.Mo.get(t).push(e):n.Mo.set(t,[e]),h.snapshot}async function Qu(e,t,n){const r=cc(e);try{const e=await function(e,r){const s=e,i=Br.now(),t=r.reduce((e,t)=>e.add(t.key),Gi());let a;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>s.Wn.vn(n,t).next(e=>{a=e;const t=[];for(const n of r){const r=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=hi(r.transform,e||null);null!=s&&(null==n&&(n=Ts.empty()),n.set(r.field,s))}return n||null}(n,a.get(n.key));null!=r&&t.push(new Di(n.key,r,function r(e){const s=[];return $r(e.fields,(e,t)=>{const n=new Qr([e]);if(ws(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new Yr(s)}(r.value.mapValue),wi.exists(!0)))}return s.An.addMutationBatch(n,i,t,r)})).then(e=>(e.applyToLocalDocumentSet(a),{batchId:e.batchId,changes:a}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Ko[e.currentUser.toKey()];r=r||new Pi(Vr),r=r.insert(t,n),e.Ko[e.currentUser.toKey()]=r}(r,e.batchId,n),await ic(r,e.changes),await Tu(r.remoteStore)}catch(e){const t=Cu(e,"Failed to persist write");n.reject(t)}}async function Yu(e,t){const r=e;try{const e=await Th(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.Uo.get(t);n&&(_r(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.$o=!0:0<e.modifiedDocuments.size?_r(n.$o):0<e.removedDocuments.size&&(_r(n.$o),n.$o=!1))}),await ic(r,e,t)}catch(e){await Ho(e)}}function Ju(r,s,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.Oo.forEach((e,t)=>{var n=t.view.ro(s);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.ro(n)&&(r=!0)}),r&&Pu(t)}(t.eventManager,s),r.length&&t.Fo.Pr(r),t.onlineState=s,t.isPrimaryClient&&t.sharedClientState.setOnlineState(s)}}async function Xu(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Qn.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=Xa.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);_r(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&s.addEntry(e,r.commitVersion))})}),a.next(()=>e.An.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.An.performConsistencyCheck(e)).next(()=>s.Wn.vn(e,t))})}(n.localStore,t);ec(n,r,null),Zu(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ic(n,e)}catch(e){await Ho(e)}}function Zu(e,t){(e.jo.get(t)||[]).forEach(e=>{e.resolve()}),e.jo.delete(t)}function ec(e,t,n){const r=e;let s=r.Ko[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Ko[r.currentUser.toKey()]=s}}function tc(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Mo.get(e))t.Oo.delete(r),n&&t.Fo.zo(r,n);t.Mo.delete(e),t.isPrimaryClient&&t.qo.us(e).forEach(e=>{t.qo.containsKey(e)||nc(t,e)})}function nc(e,t){e.Lo.delete(t.path.canonicalString());var n=e.Bo.get(t);null!==n&&(du(e.remoteStore,n),e.Bo=e.Bo.remove(t),e.Uo.delete(n),sc(e))}function rc(e,t,n){for(const r of n)r instanceof ju?(e.qo.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.Bo.get(n)||e.Lo.has(r)||(wr("SyncEngine","New document in limbo: "+n),e.Lo.add(r),sc(e))}(e,r)):r instanceof Ku?(wr("SyncEngine","Document no longer in limbo: "+r.key),e.qo.removeReference(r.key,t),e.qo.containsKey(r.key)||nc(e,r.key)):Ir()}function sc(e){for(;0<e.Lo.size&&e.Bo.size<e.maxConcurrentLimboResolutions;){var t=e.Lo.values().next().value;e.Lo.delete(t);var n=new os(Wr.fromString(t)),t=e.Qo.next();e.Uo.set(t,new Hu(n)),e.Bo=e.Bo.insert(n,t),lu(e.remoteStore,new fo(Js($s(n.path)),t,2,Pr.I))}}async function ic(e,t,r){const s=e,i=[],a=[],o=[];s.Oo.isEmpty()||(s.Oo.forEach((e,n)=>{o.push(s.Go(n,t,r).then(e=>{var t;e&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,e.fromCache?"not-current":"current"),i.push(e),t=mh.$n(n.targetId,e),a.push(t))}))}),await Promise.all(o),s.Fo.Pr(i),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>Xa.forEach(t,t=>Xa.forEach(t.kn,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>Xa.forEach(t.xn,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!ro(e))throw e;wr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.qn.get(t),n=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(n);r.qn=r.qn.insert(t,s)}}}(s.localStore,a))}async function ac(r,e){const s=r;if(uc(s),cc(s),!0===e&&!0!==s.Wo){const r=s.sharedClientState.getAllActiveQueryTargets(),e=await oc(s,r.toArray());s.Wo=!0,await _u(s.remoteStore,!0);for(const r of e)lu(s.remoteStore,r)}else if(!1===e&&!1!==s.Wo){const r=[];let n=Promise.resolve();s.Mo.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(tc(s,t),_h(s.localStore,t,!0))),du(s.remoteStore,t)}),await n,await oc(s,r),function(){const n=s;n.Uo.forEach((e,t)=>{du(n.remoteStore,t)}),n.qo.hs(),n.Uo=new Map,n.Bo=new Pi(os.comparator)}(),s.Wo=!1,await _u(s.remoteStore,!1)}}async function oc(t,n){const r=t,s=[],i=[];for(const t of n){let e;const c=r.Mo.get(t);if(c&&0!==c.length){e=await Ih(r.localStore,Js(c[0]));for(const t of c){const n=r.Oo.get(t),c=(a=r,o=n,u=h=void 0,u=await Sh((h=a).localStore,o.query,!0),u=o.view.ko(u),h.isPrimaryClient&&rc(h,o.targetId,u.Co),await u);c.snapshot&&i.push(c.snapshot)}}else{const c=await Ah(r.localStore,t);e=await Ih(r.localStore,c),await zu(r,hc(c),t,!1)}s.push(e)}var a,o,h,u;return r.Fo.Pr(i),s}function hc(e){return Ks(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function uc(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Yu.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.Uo.get(t);if(r&&r.$o)return Gi().add(r.key);{let e=Gi();const r=n.Mo.get(t);if(!r)return e;for(const t of r){const r=n.Oo.get(t);e=e.unionWith(r.view.Po)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Uo.get(t),i=s&&s.key;if(i){let e=new Pi(os.comparator);e=e.insert(i,Es.newNoDocument(i,jr.min()));const n=Gi().add(i),s=new Wi(jr.min(),new Map,new Ui(Vr),e,n);await Yu(r,s),r.Bo=r.Bo.remove(i),r.Uo.delete(t),sc(r)}else await _h(r.localStore,t,!1).then(()=>tc(r,t,n)).catch(Ho)}).bind(null,t),t.Fo.Pr=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.oo(e)&&(r=!0);s.so=e}}r&&Pu(n)}).bind(null,t.eventManager),t.Fo.zo=(function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function cc(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=Xu.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.An.lookupMutationBatch(t,r).next(e=>(_r(null!==e),n=e.keys(),s.An.removeMutationBatch(t,e))).next(()=>s.An.performConsistencyCheck(t)).next(()=>s.Wn.vn(t,n))})}(r.localStore,t);ec(r,t,n),Zu(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await ic(r,e)}catch(n){await Ho(n)}}).bind(null,t),t}class lc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.k=tu(e.databaseInfo.databaseId),this.sharedClientState=this.Jo(e),this.persistence=this.Yo(e),await this.persistence.start(),this.gcScheduler=this.Xo(e),this.localStore=this.Zo(e)}Xo(e){return null}Zo(e){return vh(this.persistence,new ph,e.initialUser,this.k)}Yo(e){return new Mh(Fh.ks,this.k)}Jo(e){return new Wh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class dc extends lc{constructor(e,t,n){super(),this.ta=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await async function(e){const t=e;return t.persistence.runTransaction("Synchronize last document change read time","readonly",t=>function(){const e=sh(t);let r=jr.min();return e.jt({index:qa.readTimeIndex,reverse:!0},(e,t,n)=>{t.readTime&&(r=vo(t.readTime)),n.done()}).next(()=>r)}()).then(e=>{t.jn=e})}(this.localStore),await this.ta.initialize(this,e),await cc(this.ta.syncEngine),await Tu(this.ta.remoteStore),await this.persistence.sn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Zo(e){return vh(this.persistence,new ph,e.initialUser,this.k)}Xo(e){var t=this.persistence.referenceDelegate.garbageCollector;return new Qo(t,e.asyncQueue)}Yo(e){var t=dh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Lo.withCacheSize(this.cacheSizeBytes):Lo.DEFAULT;return new uh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Zh(),eu(),this.k,this.sharedClientState,!!this.forceOwnership)}Jo(e){return new Wh}}class fc extends dc{constructor(e,t){super(e,t,!1),this.ta=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.ta.syncEngine;this.sharedClientState instanceof Hh&&(this.sharedClientState.syncEngine={mi:(async function(e,t,n,r){var s=e,i=await function(e,n){const r=e,s=r.An;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Zt(t,n).next(e=>e?r.Wn.vn(t,e):Xa.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await Tu(s.remoteStore):"acknowledged"===n||"rejected"===n?(ec(s,t,r||null),Zu(s,t),s.localStore.An.ee(t)):Ir(),await ic(s,i)):wr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),gi:(async function(e,t,n,r){const s=e;if(s.Wo)wr("SyncEngine","Ignoring unexpected query state notification.");else if(s.Mo.has(t))switch(n){case"current":case"not-current":{const e=await Dh(s.localStore),r=Wi.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await ic(s,e,r);break}case"rejected":await _h(s.localStore,t,!0),tc(s,t,r);break;default:Ir()}}).bind(null,t),yi:(async function(e,t,n){const r=uc(e);if(r.Wo){for(const e of t)if(r.Mo.has(e))wr("SyncEngine","Adding an already active target "+e);else{const t=await Ah(r.localStore,e),n=await Ih(r.localStore,t);await zu(r,hc(t),n.targetId,!1),lu(r.remoteStore,n)}for(const e of n)r.Mo.has(e)&&await _h(r.localStore,e,!1).then(()=>{du(r.remoteStore,e),tc(r,e)}).catch(Ho)}}).bind(null,t),Tn:(function(e){return e.localStore.persistence.Tn()}).bind(null,t),_i:(async function(e){const t=e;return Dh(t.localStore).then(e=>ic(t,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.sn(async e=>{await ac(this.ta.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):e||this.gcScheduler.stop())})}Jo(e){var t=Zh();if(!Hh.bt(t))throw new Ar(Sr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=dh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Hh(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class gc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Ju(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){wr("SyncEngine","User change. New user:",t.toKey());const r=await wh(n.localStore,t);n.currentUser=t,(e=n).jo.forEach(e=>{e.forEach(e=>{e.reject(new Ar(Sr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.jo.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await ic(n,r.Gn)}}).bind(null,this.syncEngine),await _u(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Lu}createDatastore(e){var t,n,r,s,i=tu(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new Xh(t));return n=e.authCredentials,r=e.appCheckCredentials,s=t,e=i,new au(n,r,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Ju(this.syncEngine,e,0),i=new(Qh.bt()?Qh:zh),new hu(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,a){const o=new Wu(e,t,n,r,s,i);return a&&(o.Wo=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;wr("RemoteStore","RemoteStore shutting down."),t.Gr.add(5),await cu(t),t.Hr.shutdown(),t.Jr.set("Unknown")}(this.remoteStore)}}function mc(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class pc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.ea(this.observer.next,e)}error(e){this.observer.error?this.ea(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}na(){this.muted=!0}ea(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class yc{constructor(e,t){this.sa=e,this.k=t,this.metadata=new Dr,this.buffer=new Uint8Array,this.ia=new TextDecoder("utf-8"),this.ra().then(e=>{e&&e._o()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))},e=>this.metadata.reject(e))}close(){return this.sa.cancel()}async getMetadata(){return this.metadata.promise}async Ho(){return await this.getMetadata(),this.ra()}async ra(){var e=await this.oa();if(null===e)return null;var t=this.ia.decode(e),n=Number(t);isNaN(n)&&this.aa(`length string (${t}) is not valid number`);t=await this.ca(n);return new Vu(JSON.parse(t),e.length+n)}ua(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async oa(){for(;this.ua()<0&&!await this.ha(););if(0===this.buffer.length)return null;var e=this.ua();e<0&&this.aa("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async ca(e){for(;this.buffer.length<e;)await this.ha()&&this.aa("Reached the end of bundle when more is expected.");var t=this.ia.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}aa(e){throw this.sa.cancel(),new Error(`Invalid bundle format: ${e}`)}async ha(){var e=await this.sa.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class vc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Ar(Sr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=ga(r.k)+"/documents",s={documents:t.map(e=>ca(r.k,e))},i=await r.ji("BatchGetDocuments",n,s),a=new Map;i.forEach(e=>{const t=(n=r.k,"found"in(e=e)?function(e,t){_r(!!t.found),t.found.name,t.found.updateTime;var n=la(e,t.found.name),r=oa(t.found.updateTime),s=new Ts({mapValue:{fields:t.found.fields}});return Es.newFoundDocument(n,r,s)}(n,e):"missing"in e?function(e,t){_r(!!t.missing),_r(!!t.readTime);var n=la(e,t.missing),r=oa(t.readTime);return Es.newNoDocument(n,r)}(n,e):Ir());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());_r(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new xi(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=os.fromPath(t);this.mutations.push(new Ri(n,this.precondition(n)))}),await async function(e,t){const n=e,r=ga(n.k)+"/documents",s={writes:t.map(e=>va(n.k,e))};await n.Bi("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Ir();t=jr.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Ar(Sr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?wi.updateTime(t):wi.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return wi.exists(!0);if(t.isEqual(jr.min()))throw new Ar(Sr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return wi.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class wc{constructor(e,t,n,r){this.asyncQueue=e,this.datastore=t,this.updateFunction=n,this.deferred=r,this.la=5,this.ur=new nu(this.asyncQueue,"transaction_retry")}run(){--this.la,this.fa()}fa(){this.ur.Zi(async()=>{const t=new vc(this.datastore),e=this.da(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.wa(e)}))}).catch(e=>{this.wa(e)})})}da(e){try{var t=this.updateFunction(e);return!ss(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}wa(e){0<this.la&&this._a(e)?(--this.la,this.asyncQueue.enqueueAndForget(()=>(this.fa(),Promise.resolve()))):this.deferred.reject(e)}_a(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||!Oi(t)}}class bc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=mr.UNAUTHENTICATED,this.clientId=Fr.A(),this.authCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{wr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,()=>Promise.resolve())}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ar(Sr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Dr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Cu(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function Tc(e,t){e.asyncQueue.verifyOperationInProgress(),wr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await wh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function Ec(e,t){e.asyncQueue.verifyOperationInProgress();var n=await Ic(e);wr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener(e=>async function(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),wr("RemoteStore","RemoteStore received new credentials");var r=yu(n);n.Gr.add(3),await cu(n),r&&n.Jr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.Gr.delete(3),await uu(n)}(t.remoteStore,e)),e.onlineComponents=t}async function Ic(e){return e.offlineComponents||(wr("FirestoreClient","Using default OfflineComponentProvider"),await Tc(e,new lc)),e.offlineComponents}async function _c(e){return e.onlineComponents||(wr("FirestoreClient","Using default OnlineComponentProvider"),await Ec(e,new gc)),e.onlineComponents}function Sc(e){return Ic(e).then(e=>e.persistence)}function Ac(e){return Ic(e).then(e=>e.localStore)}function Dc(e){return _c(e).then(e=>e.remoteStore)}function Cc(e){return _c(e).then(e=>e.syncEngine)}async function kc(e){const t=await _c(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=uc(e);let r,s;const i=n.Oo.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const e=await Ih(n.localStore,Js(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await zu(n,t,r,"current"===i),n.isPrimaryClient&&lu(n.remoteStore,e)}return s}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.Oo.get(t),s=n.Mo.get(r.targetId);if(1<s.length)return n.Mo.set(r.targetId,s.filter(e=>!Zs(e,t))),void n.Oo.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await _h(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),du(n.remoteStore,r.targetId),tc(n,r.targetId)}).catch(Ho)):(tc(n,r.targetId),await _h(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function Nc(e,t,n={}){const r=new Dr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,a){const e=new pc({next:e=>{r.enqueueAndForget(()=>Mu(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new Ar(Sr.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new Ar(Sr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Fu($s(s.path),e,{includeMetadataChanges:!0,wo:!0});return Ou(n,o)}(await kc(e),e.asyncQueue,t,n,r)),r.promise}function xc(e,t,n={}){const r=new Dr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,s){const i=new pc({next:e=>{n.enqueueAndForget(()=>Mu(t,a)),e.fromCache&&"server"===r.source?s.reject(new Ar(Sr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new Fu(e,i,{includeMetadataChanges:!0,wo:!0});return Ou(t,a)}(await kc(e),e.asyncQueue,t,n,r)),r.promise}function Rc(e,t,n,r){const s=(n=n,t=tu(t),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(e){if(e instanceof Uint8Array)return mc(e,void 0);if(e instanceof ArrayBuffer)return mc(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),t=t,new yc(n,t));var i;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=oa(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ye.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),void r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes});r._updateProgress(Bu(s));const a=new qu(s,t.localStore,n.k);let e=await n.Ho();for(;e;){const t=await a.yo(e);t&&r._updateProgress(t),e=await n.Ho()}var i=await a.complete();await ic(t,i.In,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ye.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress)}catch(t){Tr("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t)}}(r,t,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}(await Cc(e),s,r)})}class Lc{constructor(e,t,n,r,s,i,a,o){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class Oc{constructor(e,t){this.projectId=e,this.database=t||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Oc&&e.projectId===this.projectId&&e.database===this.database}}const Mc=new Map;function Pc(e,t,n){if(!n)throw new Ar(Sr.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Fc(e,t,n,r){if(!0===t&&!0===r)throw new Ar(Sr.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Vc(e){if(!os.isDocumentKey(e))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Uc(e){if(os.isDocumentKey(e))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function qc(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Ir();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Bc(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Ar(Sr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=qc(e);throw new Ar(Sr.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function jc(e,t){if(t<=0)throw new Ar(Sr.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Kc{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Ar(Sr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ar(Sr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Fc("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class $c{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Kc({}),this._settingsFrozen=!1,e instanceof Oc?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Ar(Sr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Oc(e.options.projectId)}(e))}get app(){if(!this._app)throw new Ar(Sr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Ar(Sr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Kc(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new kr;switch(e.type){case"gapi":var t=e.client;return _r(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new Lr(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new Ar(Sr.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Mc.get(e);t&&(wr("ComponentProvider","Removing Datastore"),Mc.delete(e),t.terminate())}(this),Promise.resolve()}}function Gc(n,e,t,r={}){var s;const i=(n=Bc(n,$c))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Tr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${t}`,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=mr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e),[a(JSON.stringify({alg:"none",type:"JWT"})),a(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Ar(Sr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new mr(i)}n._authCredentials=new Nr(new Cr(e,t))}}class Hc{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new zc(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Hc(this.firestore,e,this._key)}}class Wc{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Wc(this.firestore,e,this._query)}}class zc extends Wc{constructor(e,t,n){super(e,t,$s(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Hc(this.firestore,null,new os(e))}withConverter(e){return new zc(this.firestore,e,this._path)}}function Qc(e,t,...n){if(e=m(e),Pc("collection","path",t),e instanceof $c){var r=Wr.fromString(t,...n);return Uc(r),new zc(e,null,r)}if(!(e instanceof Hc||e instanceof zc))throw new Ar(Sr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Wr.fromString(t,...n));return Uc(r),new zc(e.firestore,null,r)}function Yc(e,t,...n){if(e=m(e),Pc("doc","path",t=1===arguments.length?Fr.A():t),e instanceof $c){var r=Wr.fromString(t,...n);return Vc(r),new Hc(e,null,new os(r))}if(!(e instanceof Hc||e instanceof zc))throw new Ar(Sr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Wr.fromString(t,...n));return Vc(r),new Hc(e.firestore,e instanceof zc?e.converter:null,new os(r))}function Jc(e,t){return e=m(e),t=m(t),(e instanceof Hc||e instanceof zc)&&(t instanceof Hc||t instanceof zc)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Xc(e,t){return e=m(e),t=m(t),e instanceof Wc&&t instanceof Wc&&e.firestore===t.firestore&&Zs(e._query,t._query)&&e.converter===t.converter}class Zc{constructor(){this.ma=Promise.resolve(),this.ga=[],this.ya=!1,this.pa=[],this.Ta=null,this.Ea=!1,this.Ia=!1,this.Aa=[],this.ur=new nu(this,"async_queue_retry"),this.Ra=()=>{var e=eu();e&&wr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.ur.er()};const e=eu();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Ra)}get isShuttingDown(){return this.ya}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pa(),this.ba(e)}enterRestrictedMode(e){if(!this.ya){this.ya=!0,this.Ia=e||!1;const t=eu();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Ra)}}enqueue(e){if(this.Pa(),this.ya)return new Promise(()=>{});const t=new Dr;return this.ba(()=>this.ya&&this.Ia?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.ga.push(e),this.va()))}async va(){if(0!==this.ga.length){try{await this.ga[0](),this.ga.shift(),this.ur.reset()}catch(e){if(!ro(e))throw e;wr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.ga.length&&this.ur.Zi(()=>this.va())}}ba(e){var t=this.ma.then(()=>(this.Ea=!0,e().catch(e=>{throw this.Ta=e,this.Ea=!1,br("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Ea=!1,e))));return this.ma=t}enqueueAfterDelay(e,t,n){this.Pa(),-1<this.Aa.indexOf(e)&&(t=0);var r=Du.createAndSchedule(this,e,t,n,e=>this.Va(e));return this.pa.push(r),r}Pa(){this.Ta&&Ir()}verifyOperationInProgress(){}async Sa(){for(var e;await(e=this.ma),e!==this.ma;);}Da(e){for(const t of this.pa)if(t.timerId===e)return!0;return!1}Ca(t){return this.Sa().then(()=>{this.pa.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.pa)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Sa()})}Na(e){this.Aa.push(e)}Va(e){var t=this.pa.indexOf(e);this.pa.splice(t,1)}}function el(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class tl{constructor(){this._progressObserver={},this._taskCompletionResolver=new Dr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var nl,rl,sl;class il extends $c{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Zc,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||ol(this),this._firestoreClient.terminate()}}function al(e){return e._firestoreClient||ol(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function ol(e){var t,n,r,s,i,a=e._freezeSettings(),a=(n=e._databaseId,r=(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",s=e._persistenceKey,i=a,new Lc(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));e._firestoreClient=new bc(e._authCredentials,e._appCheckCredentials,e._queue,a)}function hl(e,n,r){const s=new Dr;return e.asyncQueue.enqueue(async()=>{try{await Tc(e,r),await Ec(e,n),s.resolve()}catch(e){if(!("FirebaseError"===(t=e).name?t.code===Sr.FAILED_PRECONDITION||t.code===Sr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)))throw e;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}var t}).then(()=>s.promise)}function ul(e){return function(e){const t=new Dr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;yu(n.remoteStore)||wr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.An.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.jo.get(e)||[];r.push(t),n.jo.set(e,r)}catch(e){const n=Cu(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Cc(e),t)),t.promise}(al(e=Bc(e,il)))}function cl(e){return(n=al(e=Bc(e,il))).asyncQueue.enqueue(async()=>{const e=await Sc(n),t=await Dc(n);return e.setNetworkEnabled(!0),function(){const e=t;return e.Gr.delete(0),uu(e)}()});var n}function ll(e){return(n=al(e=Bc(e,il))).asyncQueue.enqueue(async()=>{const e=await Sc(n),t=await Dc(n);return e.setNetworkEnabled(!1),async function(){const e=t;e.Gr.add(0),await cu(e),e.Jr.set("Offline")}()});var n}function dl(t,e){return n=al(t=Bc(t,il)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ye.getNamedQuery(e,t))}(await Ac(n),r)).then(e=>e?new Wc(t,null,e.query):null);var n,r}function fl(e){if(e._initialized||e._terminated)throw new Ar(Sr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class gl{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Ar(Sr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Qr(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class ml{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ml(Jr.fromBase64String(e))}catch(e){throw new Ar(Sr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ml(Jr.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class pl{constructor(e){this._methodName=e}}class yl{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Ar(Sr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Ar(Sr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Vr(this._lat,e._lat)||Vr(this._long,e._long)}}const vl=/^__.*__$/;class wl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Di(e,this.data,this.fieldMask,t,this.fieldTransforms):new Ai(e,this.data,t,this.fieldTransforms)}}class bl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Di(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Tl(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Ir()}}class El{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.k=n,this.ignoreUndefinedProperties=r,void 0===s&&this.ka(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get xa(){return this.settings.xa}$a(e){return new El(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.k,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Fa(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.$a({path:n,Oa:!1});return r.Ma(e),r}La(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.$a({path:n,Oa:!1});return r.ka(),r}Ba(e){return this.$a({path:void 0,Oa:!0})}Ua(e){return jl(e,this.settings.methodName,this.settings.qa||!1,this.path,this.settings.Ka)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}ka(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ma(this.path.get(e))}Ma(e){if(0===e.length)throw this.Ua("Document fields must not be empty");if(Tl(this.xa)&&vl.test(e))throw this.Ua('Document fields cannot begin and end with "__"')}}class Il{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.k=n||tu(e)}ja(e,t,n,r=!1){return new El({xa:e,methodName:t,Ka:n,path:Qr.emptyPath(),Oa:!1,qa:r},this.databaseId,this.k,this.ignoreUndefinedProperties)}}function _l(e){var t=e._freezeSettings(),n=tu(e._databaseId);return new Il(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Sl(e,t,n,r,s,i={}){const a=e.ja(i.merge||i.mergeFields?2:0,t,n,s);Vl("Data must be an object, but it was:",a,r);var o=Pl(r,a);let h,u;if(i.merge)h=new Yr(a.fieldMask),u=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Ul(t,r,n);if(!a.contains(s))throw new Ar(Sr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Kl(e,s)||e.push(s)}h=new Yr(e),u=a.fieldTransforms.filter(e=>h.covers(e.field))}else h=null,u=a.fieldTransforms;return new wl(new Ts(o),h,u)}class Al extends pl{_toFieldTransform(e){if(2!==e.xa)throw 1===e.xa?e.Ua(`${this._methodName}() can only appear at the top level of your update data`):e.Ua(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Al}}function Dl(e,t,n){return new El({xa:3,Ka:t.settings.Ka,methodName:e._methodName,Oa:n},t.databaseId,t.k,t.ignoreUndefinedProperties)}class Cl extends pl{_toFieldTransform(e){return new yi(e.path,new ui)}isEqual(e){return e instanceof Cl}}class kl extends pl{constructor(e,t){super(e),this.Qa=t}_toFieldTransform(e){const t=Dl(this,e,!0),n=this.Qa.map(e=>Ml(e,t)),r=new ci(n);return new yi(e.path,r)}isEqual(e){return this===e}}class Nl extends pl{constructor(e,t){super(e),this.Qa=t}_toFieldTransform(e){const t=Dl(this,e,!0),n=this.Qa.map(e=>Ml(e,t)),r=new di(n);return new yi(e.path,r)}isEqual(e){return this===e}}class xl extends pl{constructor(e,t){super(e),this.Wa=t}_toFieldTransform(e){var t=new gi(e.k,ai(e.k,this.Wa));return new yi(e.path,t)}isEqual(e){return this===e}}function Rl(e,s,i,t){const a=e.ja(1,s,i);Vl("Data must be an object, but it was:",a,t);const o=[],h=Ts.empty();$r(t,(e,t)=>{var n=Bl(s,e,i);t=m(t);var r=a.La(n);if(t instanceof Al)o.push(n);else{const e=Ml(t,r);null!=e&&(o.push(n),h.set(n,e))}});var n=new Yr(o);return new bl(h,n,a.fieldTransforms)}function Ll(e,t,n,r,s,i){const a=e.ja(1,t,n),o=[Ul(t,r,n)],h=[s];if(i.length%2!=0)throw new Ar(Sr.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)o.push(Ul(t,i[f])),h.push(i[f+1]);const u=[],c=Ts.empty();for(let g=o.length-1;0<=g;--g)if(!Kl(u,o[g])){const t=o[g];var l=m(l=h[g]);const r=a.La(t);if(l instanceof Al)u.push(t);else{const e=Ml(l,r);null!=e&&(u.push(t),c.set(t,e))}}var d=new Yr(u);return new bl(c,d,a.fieldTransforms)}function Ol(e,t,n,r=!1){return Ml(n,e.ja(r?4:3,t))}function Ml(i,e){if(Fl(i=m(i)))return Vl("Unsupported field value:",e,i),Pl(i,e);if(i instanceof pl)return function(e,t){if(!Tl(t.xa))throw t.Ua(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Ua(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(i,e),null;if(void 0===i&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),i instanceof Array){if(e.settings.Oa&&4!==e.xa)throw e.Ua("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const s of i){let e=Ml(s,t.Ba(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e)}return function(e,t){if(null===(e=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return ai(t.k,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=Br.fromDate(e);return{timestampValue:ia(t.k,n)}}if(e instanceof Br){n=new Br(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ia(t.k,n)}}if(e instanceof yl)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ml)return{bytesValue:aa(t.k,e._byteString)};if(e instanceof Hc){const r=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(r))throw t.Ua(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ha(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Ua(`Unsupported field value: ${qc(e)}`)}(0,e)}function Pl(e,r){const s={};return Gr(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):$r(e,(e,t)=>{var n=Ml(t,r.Fa(e));null!=n&&(s[e]=n)}),{mapValue:{fields:s}}}function Fl(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Br||e instanceof yl||e instanceof ml||e instanceof Hc||e instanceof pl)}function Vl(e,t,n){if(!Fl(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=qc(n);throw"an object"===r?t.Ua(e+" a custom object"):t.Ua(e+" "+r)}var s}function Ul(e,t,n){if((t=m(t))instanceof gl)return t._internalPath;if("string"==typeof t)return Bl(e,t);throw jl("Field path arguments must be of type string or FieldPath.",e,!1,void 0,n)}const ql=new RegExp("[~\\*/\\[\\]]");function Bl(t,n,r){if(0<=n.search(ql))throw jl(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new gl(...n.split("."))._internalPath}catch(e){throw jl(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function jl(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let h="";return(i||a)&&(h+=" (found",i&&(h+=` in field ${r}`),a&&(h+=` in document ${s}`),h+=")"),new Ar(Sr.INVALID_ARGUMENT,o+e+h)}function Kl(e,t){return e.some(e=>e.isEqual(t))}class $l{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Hc(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Gl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Hl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Gl extends $l{data(){return super.data()}}function Hl(e,t){return"string"==typeof t?Bl(e,t):(t instanceof gl?t:t._delegate)._internalPath}class Wl{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class zl extends $l{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new Ql(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Hl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Ql extends zl{data(e={}){return super.data(e)}}class Yl{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Wl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Ql(this._firestore,this._userDataWriter,e.key,e,new Wl(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Ar(Sr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let t=0;return i._snapshot.docChanges.map(e=>({type:"added",doc:new Ql(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Wl(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:t++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Ql(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Wl(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ir()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Jl(e,t){return e instanceof zl&&t instanceof zl?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Yl&&t instanceof Yl&&e._firestore===t._firestore&&Xc(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Xl(e){if(Hs(e)&&0===e.explicitOrderBy.length)throw new Ar(Sr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Zl{}function ed(e,...t){for(const n of t)e=n._apply(e);return e}class td extends Zl{constructor(e,t,n){super(),this.Ga=e,this.za=t,this.Ha=n,this.type="where"}_apply(e){var t=_l(e.firestore),t=function(e,t,n,r,s,i,a){let o;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Ar(Sr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){hd(a,i);const t=[];for(const n of a)t.push(od(r,e,n));o={arrayValue:{values:t}}}else o=od(r,e,a)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||hd(a,i),o=Ol(n,t,a,"in"===i||"not-in"===i);var h=Cs.create(s,i,o);return function(e,t){if(t.V()){const r=zs(e);if(null!==r&&!r.isEqual(t.field))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${t.field.toString()}'`);var n=Ws(e);null!==n&&ud(0,t.field,n)}const r=function(e,t){for(const n of e.filters)if(0<=t.indexOf(n.op))return n.op;return null}(e,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new Ar(Sr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Ar(Sr.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}(e,h),h}(e._query,"where",t,e.firestore._databaseId,this.Ga,this.za,this.Ha);return new Wc(e.firestore,e.converter,(e=e._query,t=e.filters.concat([t]),new js(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))}}class nd extends Zl{constructor(e,t){super(),this.Ga=e,this.Ja=t,this.type="orderBy"}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Ar(Sr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Ar(Sr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Us(t,n);return n=s,null!==Ws(e=e)||null!==(r=zs(e))&&ud(0,r,n.field),s}(e._query,this.Ga,this.Ja);return new Wc(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new js(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class rd extends Zl{constructor(e,t,n){super(),this.type=e,this.Ya=t,this.Xa=n}_apply(e){return new Wc(e.firestore,e.converter,Xs(e._query,this.Ya,this.Xa))}}class sd extends Zl{constructor(e,t,n){super(),this.type=e,this.Za=t,this.tc=n}_apply(e){var t,n=ad(e,this.type,this.Za,this.tc);return new Wc(e.firestore,e.converter,(t=e._query,e=n,new js(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class id extends Zl{constructor(e,t,n){super(),this.type=e,this.Za=t,this.tc=n}_apply(e){var t,n=ad(e,this.type,this.Za,this.tc);return new Wc(e.firestore,e.converter,(t=e._query,e=n,new js(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function ad(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof $l)return function(e,t,n,r,s){if(!r)throw new Ar(Sr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Ys(e))if(n.field.isKeyField())i.push(gs(t,r.key));else{const e=r.data.field(n.field);if(ns(e))throw new Ar(Sr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Fs(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var s=_l(e.firestore);return function(e,t,n,r,s,i){const a=e.explicitOrderBy;if(s.length>a.length)throw new Ar(Sr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let h=0;h<s.length;h++){const u=s[h];if(a[h].field.isKeyField()){if("string"!=typeof u)throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!Qs(e)&&-1!==u.indexOf("/"))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(Wr.fromString(u));if(!os.isDocumentKey(n))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new os(n);o.push(gs(t,s))}else{const e=Ol(n,r,u);o.push(e)}}return new Fs(o,i)}(e._query,e.firestore._databaseId,s,t,n,r)}function od(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new Ar(Sr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!Qs(t)&&-1!==n.indexOf("/"))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(Wr.fromString(n));if(!os.isDocumentKey(r))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return gs(e,new os(r))}if(n instanceof Hc)return gs(e,n._key);throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${qc(n)}.`)}function hd(e,t){if(!Array.isArray(e)||0===e.length)throw new Ar(Sr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new Ar(Sr.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function ud(e,t,n){if(!n.isEqual(t))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class cd{convertValue(e,t="none"){switch(hs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return es(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ts(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Ir()}}convertObject(e,n){const r={};return $r(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new yl(es(e.latitude),es(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){var n=t.mapValue.fields.__previous_value__;return ns(n)?e(n):n}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(rs(e));default:return null}}convertTimestamp(e){var t=Zr(e);return new Br(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Wr.fromString(e);_r(ka(n));const r=new Oc(n.get(1),n.get(3)),s=new os(n.popFirst(5));return r.isEqual(t)||br(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function ld(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class dd extends cd{constructor(e){super(),this.firestore=e}convertBytes(e){return new ml(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Hc(this.firestore,null,t)}}class fd{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=_l(e)}set(e,t,n){this._verifyNotCommitted();const r=gd(e,this._firestore),s=ld(r.converter,t,n),i=Sl(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,wi.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var s=gd(e,this._firestore);let i;return i="string"==typeof(t=m(t))||t instanceof gl?Ll(this._dataReader,"WriteBatch.update",s._key,t,n,r):Rl(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,wi.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=gd(e,this._firestore);return this._mutations=this._mutations.concat(new xi(t._key,wi.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ar(Sr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function gd(e,t){if((e=m(e)).firestore!==t)throw new Ar(Sr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class md extends cd{constructor(e){super(),this.firestore=e}convertBytes(e){return new ml(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Hc(this.firestore,null,t)}}function pd(t){t=Bc(t,Hc);const n=Bc(t.firestore,il),e=al(n),r=new md(n);return function(e,t){const n=new Dr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.Wn.Rn(e,t))}(t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Ar(Sr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Cu(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Ac(e),t,n)),n.promise}(e,t._key).then(e=>new zl(n,r,t._key,e,new Wl(null!==e&&e.hasLocalMutations,!0),t.converter))}function yd(t){t=Bc(t,Wc);const n=Bc(t.firestore,il),e=al(n),r=new md(n);return function(e,t){const n=new Dr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await Sh(e,t,!0),i=new $u(t,s.zn),a=i.bo(s.documents),o=i.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=Cu(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Ac(e),t,n)),n.promise}(e,t._query).then(e=>new Yl(n,r,t,e))}function vd(e,t,n){e=Bc(e,Hc);var r=Bc(e.firestore,il),s=ld(e.converter,t,n);return Ed(r,[Sl(_l(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,wi.none())])}function wd(e,t,n,...r){e=Bc(e,Hc);var s=Bc(e.firestore,il),i=_l(s);let a;return a="string"==typeof(t=m(t))||t instanceof gl?Ll(i,"updateDoc",e._key,t,n,r):Rl(i,"updateDoc",e._key,t),Ed(s,[a.toMutation(e._key,wi.exists(!0))])}function bd(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||el(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(el(n[s])){const t=n[s];n[s]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[s+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[s+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,h;if(t instanceof Hc)o=Bc(t.firestore,il),h=$s(t._key.path),a={next:e=>{n[s]&&n[s](Id(o,t,e))},error:n[s+1],complete:n[s+2]};else{const u=Bc(t,Wc);o=Bc(u.firestore,il),h=u._query;const c=new md(o);a={next:e=>{n[s]&&n[s](new Yl(o,c,u,e))},error:n[s+1],complete:n[s+2]},Xl(t._query)}return function(e,t,n,r){const s=new pc(r),i=new Fu(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>Ou(await kc(e),i)),()=>{s.na(),e.asyncQueue.enqueueAndForget(async()=>Mu(await kc(e),i))}}(al(o),h,i,a)}function Td(e,t){return function(e,t){const n=new pc(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.io.add(t),t.next()}(await kc(e),n)),()=>{n.na(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.io.delete(t)}(await kc(e),n))}}(al(e=Bc(e,il)),el(t)?t:{next:t})}function Ed(e,t){return function(e,t){const n=new Dr;return e.asyncQueue.enqueueAndForget(async()=>Qu(await Cc(e),t,n)),n.promise}(al(e),t)}function Id(e,t,n){var r=n.docs.get(t._key),s=new md(e);return new zl(e,s,t._key,r,new Wl(n.hasPendingWrites,n.fromCache),t.converter)}class _d extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=_l(e)}get(e){const n=gd(e,this._firestore),r=new dd(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Ir();const t=e[0];if(t.isFoundDocument())return new $l(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new $l(this._firestore,r,n._key,null,n.converter);throw Ir()})}set(e,t,n){var r=gd(e,this._firestore),s=ld(r.converter,t,n),s=Sl(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){var s=gd(e,this._firestore),i="string"==typeof(t=m(t))||t instanceof gl?Ll(this._dataReader,"Transaction.update",s._key,t,n,r):Rl(this._dataReader,"Transaction.update",s._key,t);return this._transaction.update(s._key,i),this}delete(e){var t=gd(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=gd(e,this._firestore),n=new md(this._firestore);return super.get(e).then(e=>new zl(this._firestore,n,t._key,e._document,new Wl(!1,!1),t.converter))}}function Sd(t,n){return function(t,n){const r=new Dr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await _c(t).then(e=>e.datastore);new wc(t.asyncQueue,e,n,r).run()}),r.promise}(al(t=Bc(t,il)),e=>n(new _d(t,e)))}nl=Xd.SDK_VERSION,pr=nl,Xd._registerComponent(new i("firestore",(e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=new il(n,new xr(e.getProvider("auth-internal")),new Mr(e.getProvider("app-check-internal")));return t=Object.assign({useFetchStreams:!0},t),r._setSettings(t),r},"PUBLIC")),Xd.registerVersion(gr,"3.4.1",void 0),Xd.registerVersion(gr,"3.4.1","esm2017");function Ad(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Ar("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function Dd(){if("undefined"==typeof Uint8Array)throw new Ar("unimplemented","Uint8Arrays are not available in this environment.")}function Cd(){if("undefined"==typeof atob)throw new Ar("unimplemented","Blobs are unavailable in Firestore in this environment.")}class kd{constructor(e){this._delegate=e}static fromBase64String(e){return Cd(),new kd(ml.fromBase64String(e))}static fromUint8Array(e){return Dd(),new kd(ml.fromUint8Array(e))}toBase64(){return Cd(),this._delegate.toBase64()}toUint8Array(){return Dd(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Nd(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class xd{enableIndexedDbPersistence(e,t){return function(e,t){fl(e=Bc(e,il));var n=al(e),r=e._freezeSettings(),s=new gc;return hl(n,s,new dc(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){fl(e=Bc(e,il));var t=al(e),n=e._freezeSettings(),r=new gc;return hl(t,r,new fc(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Ar(Sr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Dr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!eo.bt())return Promise.resolve();var t=e+"main";await eo.delete(t)}(dh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class Rd{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Oc||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Tr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){Gc(this._delegate,e,t,n)}enableNetwork(){return cl(this._delegate)}disableNetwork(){return ll(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Fc("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return ul(this._delegate)}onSnapshotsInSync(e){return Td(this._delegate,e)}get app(){if(!this._appCompat)throw new Ar("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Hd(this,Qc(this._delegate,e))}catch(e){throw Vd(e,"collection()","Firestore.collection()")}}doc(e){try{return new Fd(this,Yc(this._delegate,e))}catch(e){throw Vd(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Kd(this,function(e,t){if(e=Bc(e,$c),Pc("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Ar(Sr.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Wc(e,null,(t=t,new js(Wr.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Vd(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Sd(this._delegate,e=>t(new Od(this,e)))}batch(){return al(this._delegate),new Md(new fd(this._delegate,e=>Ed(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=al(t=Bc(t,il)),r=new tl,Rc(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return dl(this._delegate,e).then(e=>e?new Kd(this,e):null)}}class Ld extends cd{constructor(e){super(),this.firestore=e}convertBytes(e){return new kd(new ml(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return Fd.forKey(t,this.firestore,null)}}class Od{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Ld(e)}get(e){const t=Wd(e);return this._delegate.get(t).then(e=>new Bd(this._firestore,new zl(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Wd(e);return n?(Ad("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=Wd(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=Wd(e);return this._delegate.delete(t),this}}class Md{constructor(e){this._delegate=e}set(e,t,n){var r=Wd(e);return n?(Ad("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=Wd(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=Wd(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Pd{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new Ql(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new jd(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Pd.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let s=r.get(t);return s||(s=new Pd(e,new Ld(e),t),r.set(t,s)),s}}Pd.INSTANCES=new WeakMap;class Fd{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Ld(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Ar("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new Fd(t,new Hc(t._delegate,n,new os(e)))}static forKey(e,t,n){return new Fd(t,new Hc(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Hd(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Hd(this.firestore,Qc(this._delegate,e))}catch(e){throw Vd(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof Hc&&Jc(this._delegate,e)}set(e,t){t=Ad("DocumentReference.set",t);try{return t?vd(this._delegate,e,t):vd(this._delegate,e)}catch(e){throw Vd(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?wd(this._delegate,e):wd(this._delegate,e,t,...n)}catch(e){throw Vd(e,"updateDoc()","DocumentReference.update()")}}delete(){return Ed(Bc((e=this._delegate).firestore,il),[new xi(e._key,wi.none())]);var e}onSnapshot(...e){var t=Ud(e),n=qd(e,e=>new Bd(this.firestore,new zl(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return bd(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?pd:"server"===(null==e?void 0:e.source)?function(t){t=Bc(t,Hc);const n=Bc(t.firestore,il);return Nc(al(n),t._key,{source:"server"}).then(e=>Id(n,t,e))}:function(t){t=Bc(t,Hc);const n=Bc(t.firestore,il);return Nc(al(n),t._key).then(e=>Id(n,t,e))})(this._delegate),t.then(e=>new Bd(this.firestore,new zl(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new Fd(this.firestore,e?this._delegate.withConverter(Pd.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Vd(e,t,n){return e.message=e.message.replace(t,n),e}function Ud(e){for(const t of e)if("object"==typeof t&&!Nd(t))return t;return{}}function qd(e,t){var n;let r;return r=Nd(e[0])?e[0]:Nd(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Bd{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Fd(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Jl(this._delegate,e._delegate)}}class jd extends Bd{data(e){var t=this._delegate.data(e);return void 0!==t||Ir(),t}}class Kd{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Ld(e)}where(e,t,n){try{return new Kd(this.firestore,ed(this._delegate,(r=n,s=t,i=Hl("where",e),new td(i,s,r))))}catch(e){throw Vd(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new Kd(this.firestore,ed(this._delegate,([n,r="asc"]=[e,t],s=r,i=Hl("orderBy",n),new nd(i,s))))}catch(e){throw Vd(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new Kd(this.firestore,ed(this._delegate,(jc("limit",t=e),new rd("limit",t,"F"))))}catch(e){throw Vd(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new Kd(this.firestore,ed(this._delegate,(jc("limitToLast",t=e),new rd("limitToLast",t,"L"))))}catch(e){throw Vd(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new Kd(this.firestore,ed(this._delegate,function(...e){return new sd("startAt",e,!0)}(...e)))}catch(e){throw Vd(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Kd(this.firestore,ed(this._delegate,function(...e){return new sd("startAfter",e,!1)}(...e)))}catch(e){throw Vd(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Kd(this.firestore,ed(this._delegate,function(...e){return new id("endBefore",e,!0)}(...e)))}catch(e){throw Vd(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Kd(this.firestore,ed(this._delegate,function(...e){return new id("endAt",e,!1)}(...e)))}catch(e){throw Vd(e,"endAt()","Query.endAt()")}}isEqual(e){return Xc(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?yd:"server"===(null==e?void 0:e.source)?function(t){t=Bc(t,Wc);const n=Bc(t.firestore,il),e=al(n),r=new md(n);return xc(e,t._query,{source:"server"}).then(e=>new Yl(n,r,t,e))}:function(t){t=Bc(t,Wc);const n=Bc(t.firestore,il),e=al(n),r=new md(n);return Xl(t._query),xc(e,t._query).then(e=>new Yl(n,r,t,e))})(this._delegate),t.then(e=>new Gd(this.firestore,new Yl(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=Ud(e),n=qd(e,e=>new Gd(this.firestore,new Yl(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return bd(this._delegate,t,n)}withConverter(e){return new Kd(this.firestore,e?this._delegate.withConverter(Pd.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class $d{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new jd(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Gd{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Kd(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new jd(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new $d(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new jd(this._firestore,e))})}isEqual(e){return Jl(this._delegate,e._delegate)}}class Hd extends Kd{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new Fd(this.firestore,e):null}doc(e){try{return void 0===e?new Fd(this.firestore,Yc(this._delegate)):new Fd(this.firestore,Yc(this._delegate,e))}catch(e){throw Vd(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Bc(e.firestore,il),r=Yc(e),s=ld(e.converter,t);return Ed(n,[Sl(_l(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,wi.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new Fd(this.firestore,e))}isEqual(e){return Jc(this._delegate,e._delegate)}withConverter(e){return new Hd(this.firestore,e?this._delegate.withConverter(Pd.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Wd(e){return Bc(e,Hc)}const zd={Firestore:Rd,GeoPoint:yl,Timestamp:Br,Blob:kd,Transaction:Od,WriteBatch:Md,DocumentReference:Fd,DocumentSnapshot:Bd,Query:Kd,QueryDocumentSnapshot:jd,QuerySnapshot:Gd,CollectionReference:Hd,FieldPath:class Qd{constructor(...e){this._delegate=new gl(...e)}static documentId(){return new Qd(Qr.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof gl&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class Yd{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Cl("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new Yd(e)}static delete(){const e=new Al("deleteField");return e._methodName="FieldValue.delete",new Yd(e)}static arrayUnion(...e){const t=function(...e){return new kl("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new Yd(t)}static arrayRemove(...e){const t=function(...e){return new Nl("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new Yd(t)}static increment(e){const t=new xl("increment",e);return t._methodName="FieldValue.increment",new Yd(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,yr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};rl=t.default,sl=(e,t)=>new Rd(e,t,new xd),rl.INTERNAL.registerComponent(new i("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return sl(t,n)},"PUBLIC").setServiceProps(Object.assign({},zd))),rl.registerVersion("@firebase/firestore-compat","0.1.10")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
